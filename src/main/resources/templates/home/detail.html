<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="|${home.title} 상세 정보|">숙소 상세 정보</title>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b272e4b2002adaa34552559ea8333230&libraries=services"></script>
<script type="text/javascript">
    // 카카오 지도 API가 로드된 후 실행되는 코드
    kakao.maps.load(function() {
    	/*
        var geocoder = new kakao.maps.services.Geocoder();
        
     // Thymeleaf에서 전달된 home.address 값을 JavaScript 변수로 사용
        var address = /*[[${home.address}]] '';  // home.address 값을 Thymeleaf에서 가져오기
        
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                var mapContainer = document.getElementById('map');
                var mapOption = {
                    center: coords,
                    level: 3
                };
                var map = new kakao.maps.Map(mapContainer, mapOption);
                var marker = new kakao.maps.Marker({
                    position: coords
                });
                marker.setMap(map);
            }
        });
        */
        
    	var address = /*[[${home.address}]]*/ '서울특별시 중구 을지로 79'; // 이 값은 Thymeleaf에서 동적으로 전달된 주소로 바뀌어야 합니다.

    	var geocoder = new kakao.maps.services.Geocoder();
    	geocoder.addressSearch(address, function(result, status) {
    	    if (status === kakao.maps.services.Status.OK) {
    	        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
    	        var mapContainer = document.getElementById('map');
    	        var mapOption = {
    	            center: coords,
    	            level: 3
    	        };
    	        var map = new kakao.maps.Map(mapContainer, mapOption);
    	        var marker = new kakao.maps.Marker({
    	            position: coords
    	        });
    	        marker.setMap(map);
    	    }
    	});

    });
</script>
<style>
body {
	font-family: Arial, sans-serif;
	line-height: 1.6;
	margin: 0;
	padding: 20px;
	background-color: #f4f4f4;
}

.container {
	max-width: 1200px;
	margin: auto;
	background: white;
	padding: 20px;
	border-radius: 8px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.gallery {
	display: flex;
	flex-wrap: wrap;
	gap: 10px;
	margin-bottom: 20px;
}

.main-img, .sub-img {
	flex: 1;
	min-width: 200px;
	max-height: 300px;
	overflow: hidden;
}

.main-img img, .sub-img img {
	width: 100%;
	height: 100%;
	object-fit: cover;
	border-radius: 5px;
}

.main-img {
	flex-basis: 50%;
}

.info-section {
	display: flex;
	justify-content: space-between;
	gap: 40px;
}

.description-box, .booking-box {
	flex: 1;
}

.booking-box {
	border: 1px solid #ddd;
	padding: 20px;
	border-radius: 8px;
}

.price {
	font-size: 2em;
	font-weight: bold;
	color: #333;
	margin-bottom: 20px;
}

.host-info {
	display: flex;
	align-items: center;
	margin-top: 20px;
	padding-top: 20px;
	border-top: 1px solid #eee;
}

.host-img {
	width: 50px;
	height: 50px;
	border-radius: 50%;
	margin-right: 10px;
	object-fit: cover;
}

#map {
            width: 100%;
            height: 400px;
        }
.review-card {
	border-bottom: 1px solid #eee;
	padding: 15px 0;
}

.facility-group {
	display: flex;
	justify-content: space-between;
	margin-top: 20px;
}

.policy-item {
	flex: 1;
	padding: 0 10px;
}
</style>

<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</head>
<body>
<div th:insert="fragments/header :: menuBar"></div>
<div th:insert="fragments/search :: searchSection"></div>

	<div class="container">

		<h1 th:text="${home.title}">숙소 제목</h1>

		<p>
			<span th:text="|최대 인원: ${home.maxPeople}명|">최대 인원</span>
			<span th:text="| · 침실 ${home.room}개|"> · 침실</span>
			<span th:text="| · 침대 ${home.bed}개|"> · 침대</span>
			<span th:text="| · 욕실 ${home.bath}개|"> · 욕실</span>
		</p>

		<p th:if="${rating != null}">
			<span class="rating" th:text="|★ ${rating} · 후기 ${reviewCount}개|">★
				4.9 · 후기 12개</span>
		</p>

<div class="gallery">
    <div class="main-img">
        <img th:src="${homePhoto.imgOne != null ? homePhoto.imgOne : '/images/default_main_image.jpg'}" 
             src="/images/sample_main.jpg" alt="메인 숙소 이미지">
    </div>

    <th:block th:each="image, iterStat : ${homePhoto.images}">
        <div class="sub-img" th:if="${iterStat.index > 0}">
            <img th:src="${image}" 
                 src="/images/sample_sub.jpg" alt="서브 숙소 이미지">
        </div>
    </th:block>

    </div>
    
		<div class="info-section">


			<div class="description-box">
				<h2>숙소 설명</h2>

				<div id="original-description" style="display:none;" th:attr="data-full-content=${home.description}">
					<p>숙소 설명 원본이 들어갑니다.</p>
				</div>
				
				<div id="short-description">
					</div>

				<button id="toggle-button" onclick="toggleDescription()" style="display: none;">더 보기</button>

				<div class="host-info" th:if="${home.host != null}">
					<img class="host-img" th:src="${home.host.profileImg}"
						src="/images/host_default.jpg" alt="호스트 이미지">
					<div>
						<p th:text="|호스트: ${home.host.username}|">호스트: 홍길동 님</p>
						<p th:if="${hostMemberSince != null}"
							th:text="|호스트 활동 기간: ${hostMemberSince}년|">호스트 활동 기간: 3년</p>
						<form th:action="@{/chat/room/question}" method="post">
						    <input type="hidden" name="nickname" th:value="${home.host.nickname}" />
						    <button type="submit">문의하기</button>
						</form>
					</div>
				</div>
			</div>

			<form th:action="@{/home/reservationStart}" method="get" class="booking-box" id="bookingForm">
				<input type="hidden" name="reservedHome" th:value="${home.idx}" />
				
				<input type="hidden" id="basicCost" th:value="${home.costBasic}" />
                <input type="hidden" id="expenCost" th:value="${home.costExpen}" />
                
                <input type="hidden" id="nights" name="nights" value="0" />
                <input type="hidden" id="totalCost" name="totalMoney" value="0" />


				<div class="price">
					<span
						th:text="|${#numbers.formatInteger(home.costBasic, 3, 'COMMA')}원|">720,000원</span>
					<span> · 1박 기준</span>
				</div>

				<div class="dates">
					<label for="startDate">체크인</label> <input type="date"
						id="startDate" name="startDate"
						th:value="${startDate != null} ? ${#temporals.format(startDate,'yyyy-MM-dd')} : ''"
						th:attr="min=${#temporals.format(today,'yyyy-MM-dd')}" /> <label
						for="endDate">체크아웃</label> <input type="date" id="endDate"
						name="endDate"
						th:value="${endDate != null} ? ${#temporals.format(endDate,'yyyy-MM-dd')} : ''"
						th:attr="min=${#temporals.format(tomorrow,'yyyy-MM-dd')}" />
				</div>

				<p th:text="|이 숙소의 최대 인원은 ${home.maxPeople}명 (어린이 제외)입니다.|" 
				   style="font-size: 0.9em; margin-bottom: 5px; color: #555;">
					이 숙소의 최대 인원은 10명 (어린이 제외)입니다.
				</p>

				<select name="adult" id="guests">
					<option th:each="guest : ${#numbers.sequence(1, home.maxPeople)}"
						th:value="${guest}" th:text="|성인 ${guest}명|">성인 2명</option>
				</select>
                
				<select name="child" id="children" style="margin-top: 10px;">
					<option value="0">어린이 0명</option>
					<option th:each="child : ${#numbers.sequence(1, 5)}"
						th:value="${child}" th:text="|어린이 ${child}명|">어린이 1명</option>
				</select>
                
                <div id="total-price-box" style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee;">
                    <p id="totalPriceDisplay" style="font-size: 1.2em; font-weight: bold;">날짜를 선택해 주세요.</p>
                </div>


				<button type="submit">예약하기</button>
				<p>예약 확정 전에는 요금이 청구되지 않습니다.</p>
			</form>


			</div>

	<div class="bedroom-section">
		<h2>숙박 장소</h2>

		<div th:if="${rooms != null}" th:each="room, iterStat : ${rooms}">
			<div th:text="|침실 ${iterStat.count}|">침실 1</div>
			<div th:text="|${room.bedType} ${room.bedCount}개|">퀸사이즈 침대 1개</div>
		</div>

		<div th:if="${rooms == null}">
			<div th:text="|침실 ${home.room}개|">침실 3개</div>
			<div th:text="${home.address}"></div>
		</div>
	</div>
<!-- 
	<div class="map-section">
		<h2>위치</h2>
		<p th:text="${home.address}">대한민국, 경상북도 포항시</p>
	</div>
-->

    <!-- 지도를 표시할 div -->
    <div id="map"></div>

    
	<div class="review-section">
		<h2>★ 4.9 · 후기 12개</h2>

		<div class="review-card">
			<p>박*근</p>
			<p>호스트 활동 기간 3년</p>
			<p>모든 것이 완벽했고 오션뷰가 정말 좋았습니다...</p>
			<button>더보기</button>
		</div>
	</div>

	<div class="amenities-section">
		<h2>숙소 편의시설</h2>
		<ul>
			<li th:if="${hashtag != null and hashtag.wifi}">와이파이</li>
			<li th:if="${hashtag != null and hashtag.tv}">TV</li>
			<li th:if="${hashtag != null and hashtag.kitchen}">주방</li>
			<li th:if="${hashtag != null and hashtag.freePark}">무료 주차</li>
			<li th:if="${hashtag != null and hashtag.selfCheckin}">셀프 체크인</li>
			<li th:if="${hashtag != null and hashtag.coldWarm}">냉난방</li>
			<li th:if="${hashtag != null and hashtag.petFriendly}">반려동물 동반</li>
			<li th:if="${hashtag != null and hashtag.barrierFree}">장애물 없는 시설</li>
			<li th:if="${hashtag != null and hashtag.elevator}">엘리베이터</li>
		</ul>

		<div th:if="${optionsByGroup != null and not #maps.isEmpty(optionsByGroup)}">
			<th:block th:each="entry : ${optionsByGroup}">
				<h3 th:text="${entry.key}">옵션 그룹</h3> 
				<ul>
					<li th:each="opt : ${entry.value}" th:text="${opt.optionName}">옵션명</li>
				</ul>
			</th:block>
		</div>
		
		<div th:if="${optionsByGroup == null or #maps.isEmpty(optionsByGroup)}">
		    <p>등록된 추가 옵션이 없습니다.</p>
		</div>

		<button>더 보기</button>
	</div>

	<div class="rules-section">
		<h2>알아두어야 할 사항</h2>
		<div class="facility-group">
			<div class="policy-item">
				<h3>숙소 이용 규칙</h3>
				<p th:text="|체크인 시간: ${home.checkIn}시|">체크인 시간: 15시</p>
				<p th:text="|체크아웃 시간: ${home.checkOut}시|">체크아웃 시간: 11시</p>
				<p th:text="|게스트 정원: ${home.maxPeople}명|">게스트 정원: 10명</p>
				<button>더 보기</button>
			</div>

			<div class="policy-item">
				<h3>안전 및 공간</h3>
				<p>일산화탄소 경보기 없음</p>
				<p>부지 내 실내 보안 카메라</p>
				<p>화재경보기</p>
				<button>더 보기</button>
			</div>

			<div class="policy-item">
				<h3>환불 정책</h3>
				<p>24시간 무료 취소 가능...</p>
				<button>더 보기</button>
			</div>

			</div>
	</div>

	</div>

<script>
    const MAX_LENGTH = 300; // 최대 길이 설정

    // ==========================================================
    // 1. 숙소 설명 토글 로직 (기존 및 수정된 로직)
    // ==========================================================

    // 페이지 로드 시 실행되는 함수
    document.addEventListener('DOMContentLoaded', function() {
        const originalDescElement = document.getElementById('original-description');
        // 'data-full-content'에서 원본 HTML 내용을 가져옴
        const originalContent = originalDescElement ? originalDescElement.getAttribute('data-full-content') : "";
        
        // 순수 텍스트 내용 (길이 체크를 위해)
        const plainTextContent = new DOMParser().parseFromString(originalContent, 'text/html').documentElement.textContent.trim();

        const shortDescElement = document.getElementById('short-description');
        const toggleButton = document.getElementById('toggle-button');
        
        // ******************** 수정된 로직 시작 ********************
        // (HTML 태그를 유지하면서 내용 자르기)
        if (plainTextContent.length > MAX_LENGTH) {
            // 원본 HTML 스트링 자체를 잘라 사용합니다. (줄바꿈 태그 유지를 위함)
            let shortHTMLContent = originalContent.substring(0, MAX_LENGTH);
            
            // 줄임표를 추가합니다.
            if (!shortHTMLContent.endsWith('...')) { 
                 shortHTMLContent += '...'; 
            }
            
            // HTML에 자른 내용을 표시 (태그 포함)
            shortDescElement.innerHTML = shortHTMLContent;
            
            // 버튼 표시
            toggleButton.style.display = 'block';

            // 상태를 "short"으로 설정
            shortDescElement.setAttribute('data-current-state', 'short');
        } else {
            // 300자 이하인 경우: 전체 내용 표시 및 버튼 숨김 (HTML 포함)
            shortDescElement.innerHTML = originalContent;
            toggleButton.style.display = 'none';
        }
        // ******************** 수정된 로직 끝 ********************
        
        // ==========================================================
        // 2. 예약 가격 계산 로직 (새로 추가된 로직)
        // ==========================================================
        
        // 2-1. 가격 정보 가져오기 (Thymeleaf Hidden Field에서)
        const basicCostElement = document.getElementById('basicCost');
        const expenCostElement = document.getElementById('expenCost');
        
        // 값이 null이거나 숫자가 아니면 0 또는 기본값으로 설정
        const basicCost = basicCostElement ? parseInt(basicCostElement.value) || 0 : 0;
        const expenCost = expenCostElement ? parseInt(expenCostElement.value) || 0 : 0;


        // 2-2. DOM 요소 선택
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const nightsInput = document.getElementById('nights');
        const totalCostInput = document.getElementById('totalCost');
        
        // 2-3. 이벤트 리스너 등록
        startDateInput.addEventListener('change', calculatePrice);
        endDateInput.addEventListener('change', calculatePrice);

        // 페이지 로드 시 초기 가격 계산 (만약 날짜가 미리 채워져 있다면)
        calculatePrice();


        /**
         * 특정 날짜가 주말(금요일 또는 토요일)인지 확인합니다.
         * @param {Date} date - 확인할 날짜 객체
         * @returns {boolean} 주말이면 true (금=5, 토=6)
         */
        function isWeekend(date) {
            const dayOfWeek = date.getDay();
            // 5: 금요일, 6: 토요일
            return dayOfWeek === 5 || dayOfWeek === 6;
        }

        /**
         * 체크인/체크아웃 날짜를 기반으로 총 숙박 가격을 계산합니다.
         */
        function calculatePrice() {
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;
            
            // 날짜가 모두 선택되지 않았다면 종료
            if (!startDateStr || !endDateStr) {
                totalPriceDisplay.textContent = '날짜를 선택해 주세요.';
                nightsInput.value = 0;
                totalCostInput.value = 0;
                return;
            }

            // Date 객체 생성 (날짜만 포함)
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // 시간 부분을 00:00:00으로 설정하여 날짜 비교 정확도 향상
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);

            // 유효성 검사: 체크아웃이 체크인보다 이전이거나 같으면 에러
            if (endDate <= startDate) {
                totalPriceDisplay.textContent = '유효하지 않은 날짜 범위입니다.';
                nightsInput.value = 0;
                totalCostInput.value = 0;
                return;
            }

            let totalCost = 0;
            let nights = 0;
            
            // 체크인 날짜부터 체크아웃 전날까지 반복 (1박씩 계산)
            let currentDate = new Date(startDate);
            
            while (currentDate < endDate) {
                // 숙박 시작일이 주말(금/토)인지 확인하여 가격 적용
                const costPerNight = isWeekend(currentDate) ? expenCost : basicCost;
                totalCost += costPerNight;
                nights++;

                // 다음 날짜로 이동 (1일 추가)
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // 결과 업데이트
            nightsInput.value = nights;
            totalCostInput.value = totalCost;

            // 화면에 표시 (toLocaleString으로 콤마(,) 추가)
            const formattedTotalCost = totalCost.toLocaleString('ko-KR');
            totalPriceDisplay.innerHTML = `총 ${nights}박<br><span>${formattedTotalCost}원</span>`;
        }
        
    }); // DOMContentLoaded 끝

    // "더 보기/닫기" 토글 함수 (이 함수는 밖에 두는 것이 일반적입니다)
    function toggleDescription() {
        const shortDescElement = document.getElementById('short-description');
        const originalDescElement = document.getElementById('original-description');
        const toggleButton = document.getElementById('toggle-button');
        
        const currentState = shortDescElement.getAttribute('data-current-state');
        // 원본 내용은 hidden div의 data-full-content 속성에서 가져옵니다.
        const fullContent = originalDescElement.getAttribute('data-full-content');
        
        // 순수 텍스트 내용으로 길이 체크를 다시 합니다.
        const plainTextContent = new DOMParser().parseFromString(fullContent, 'text/html').documentElement.textContent.trim();
        
        // HTML 문자열을 직접 잘라 태그를 유지합니다.
        let shortHTMLContent = fullContent.substring(0, MAX_LENGTH);
         if (!shortHTMLContent.endsWith('...')) {
             shortHTMLContent += '...';
         }

        if (currentState === 'short') {
            // 현재 짧은 내용 -> 전체 내용으로 변경 (HTML 포함)
            shortDescElement.innerHTML = fullContent;
            toggleButton.textContent = '닫기';
            shortDescElement.setAttribute('data-current-state', 'full');
        } else {
            // 현재 전체 내용 -> 짧은 내용으로 변경 (HTML 포함)
            shortDescElement.innerHTML = shortHTMLContent; 
            toggleButton.textContent = '더 보기';
            shortDescElement.setAttribute('data-current-state', 'short');
        }
    }
</script>

</body>
</html>