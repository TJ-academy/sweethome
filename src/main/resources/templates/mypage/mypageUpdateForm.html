<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>회원정보 수정 | 마이페이지</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
  <link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
  
  <script>
    function setSubmitEnabled(enabled) {
      document.getElementById("submitBtn").disabled = !enabled;
    }

    // ✅ 닉네임 중복 확인
    async function checkNicknameDuplicate() {
      const nicknameEl = document.getElementById('nickname');
      const nickname = nicknameEl.value.trim();
      const originalNickname = nicknameEl.getAttribute('data-original');
      
      if (!nickname) {
        alert('닉네임을 입력해주세요.');
        return;
      }

      // ✅ 기존 닉네임과 동일하면 서버 확인 없이 바로 통과
      if (nickname === originalNickname) {
        alert('현재 사용 중인 닉네임입니다. 그대로 사용 가능합니다.');
        document.getElementById('nicknameVerified').value = 'true';
        setSubmitEnabled(true);
        document.getElementById('nickHelp').textContent = '현재 닉네임을 그대로 사용 중입니다.';
        return;
      }

      // ✅ 닉네임 변경 시 서버 중복 검사
      try {
        const res = await fetch('/user/checkNicknameDuplicate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `nickname=${encodeURIComponent(nickname)}`
        });
        const result = await res.text();

        if (result === 'duplicate') {
          alert('이미 사용 중인 닉네임입니다.');
          document.getElementById('nicknameVerified').value = 'false';
          setSubmitEnabled(false);
          document.getElementById('nickHelp').textContent = '다른 닉네임을 입력해주세요.';
          nicknameEl.focus();
        } else if (result === 'ok') {
          alert('사용 가능한 닉네임입니다.');
          document.getElementById('nicknameVerified').value = 'true';
          setSubmitEnabled(true);
          document.getElementById('nickHelp').textContent = '사용 가능한 닉네임입니다.';
        } else {
          throw new Error('알 수 없는 응답: ' + result);
        }
      } catch (err) {
        console.error(err);
        alert('중복 확인 중 오류가 발생했습니다.');
        document.getElementById('nicknameVerified').value = 'false';
        setSubmitEnabled(false);
      }
    }

    // ✅ 유효성 검사
    function validateForm() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const phone = document.getElementById('phone').value;
      const verified = document.getElementById('nicknameVerified').value === 'true';

      if (!verified) {
        alert('닉네임 중복 확인을 먼저 진행해주세요.');
        return false;
      }

      if (newPassword && newPassword !== confirmPassword) {
        alert('새 비밀번호와 비밀번호 확인이 일치하지 않습니다.');
        return false;
      }

      const phonePattern = /^\d{2,3}-\d{3,4}-\d{4}$/;
      if (phone && !phonePattern.test(phone)) {
        alert('전화번호 형식이 올바르지 않습니다. (예: 010-1234-5678)');
        return false;
      }

      return true;
    }

    // ✅ 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function () {
      setSubmitEnabled(false);
      const nicknameEl = document.getElementById('nickname');
      nicknameEl.addEventListener('input', function () {
        document.getElementById('nicknameVerified').value = 'false';
        setSubmitEnabled(false);
        document.getElementById('nickHelp').textContent = '중복 확인을 완료해야 저장할 수 있습니다.';
      });
    });
  </script>
</head>

<body>
<div th:insert="~{fragments/header :: menuBar}"></div>

<div class="mypage-layout-wrap container-fluid">
  <div class="row">
    <div class="mypage-sidebar-col">
      <div th:insert="~{fragments/sidebar :: guestSideBar}"></div>
    </div>

    <div class="mypage-content-col">
      <div class="mypage-content-area">
        <h1>회원정보 수정</h1>

        <form th:action="@{/mypage/update}" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
          <input type="hidden" name="email" th:value="${user.email}" />

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">이메일 (ID)</label>
            <div class="col-sm-9">
              <input type="text" class="form-control-plaintext" th:value="${user.email}" readonly>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">가입일</label>
            <div class="col-sm-9">
              <input type="text" class="form-control-plaintext" th:value="${#temporals.format(user.joinAt, 'yyyy-MM-dd HH:mm:ss')}" readonly>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">이름</label>
            <div class="col-sm-9">
              <input type="text" class="form-control-plaintext" th:value="${user.username}" readonly>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">생년월일</label>
            <div class="col-sm-9">
              <input type="text" class="form-control-plaintext" th:value="${user.birthday}" readonly>
            </div>
          </div>

          <div class="mb-3 row">
            <label for="newPassword" class="col-sm-3 col-form-label">새 비밀번호</label>
            <div class="col-sm-9">
              <input type="password" class="form-control" id="newPassword" name="newPassword" placeholder="변경할 비밀번호 (선택)">
              <small class="text-muted">변경을 원하지 않으면 비워두세요.</small>
            </div>
          </div>

          <div class="mb-3 row">
            <label for="confirmPassword" class="col-sm-3 col-form-label">비밀번호 확인</label>
            <div class="col-sm-9">
              <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
            </div>
          </div>

          <div class="mb-3 row">
            <label for="nickname" class="col-sm-3 col-form-label">닉네임</label>
            <div class="col-sm-6">
              <!-- ✅ 기존 닉네임을 data-original로 보관 -->
              <input type="text" class="form-control" id="nickname" name="nickname"
                     th:value="${user.nickname}" th:attr="data-original=${user.nickname}" required>
              <div id="nickHelp" class="form-text">중복 확인을 완료해야 저장할 수 있습니다.</div>
            </div>
            <div class="col-sm-3 d-flex align-items-center gap-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="checkNicknameDuplicate()">중복확인</button>
              <input type="hidden" id="nicknameVerified" name="nicknameVerified" value="false">
            </div>
          </div>

          <div class="mb-3 row">
            <label for="phone" class="col-sm-3 col-form-label">전화번호</label>
            <div class="col-sm-9">
              <input type="text" class="form-control" id="phone" name="phone" th:value="${user.phone}" placeholder="예: 010-1234-5678">
            </div>
          </div>

          <div class="mb-3 row">
            <label for="profileImage" class="col-sm-3 col-form-label">프로필 사진</label>
            <div class="col-sm-9">
              <img th:src="${user.profileImg}" alt="현재 프로필 이미지" class="mb-2"
                   style="max-width: 100px; max-height: 100px; border-radius: 50%;">
              <input type="file" class="form-control" id="profileImage" name="profileImage">
              <small class="text-muted">새 파일을 선택하면 기존 이미지가 변경됩니다.</small>
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="submit" id="submitBtn" class="btn btn-success" disabled>정보 수정 완료</button>
            <a th:href="@{/mypage}" class="btn btn-secondary">취소</a>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
</body>
</html>
