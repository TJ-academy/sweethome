<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="|예약 상세 내역: ${reservation.reservedHome.title}|">예약
	상세 내역</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
	rel="stylesheet">
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
<style>
.detail-section {
	border: 1px solid #ddd;
	padding: 20px;
	border-radius: 8px;
	margin-bottom: 20px;
}

.detail-item {
	padding: 8px 0;
	border-bottom: 1px dashed #eee;
	display: flex;
	justify-content: space-between;
}

.detail-item:last-child {
	border-bottom: none;
}

.item-label {
	font-weight: 500;
	color: #555;
}

.item-value {
	font-weight: 600;
}
</style>
</head>
<body>

	<div th:insert="~{fragments/header :: menuBar}"></div>

	<div class="container my-4">
		<div class="row">
			<div class="col-12 col-lg-3">
				<div th:insert="~{fragments/sidebar :: guestSideBar}"></div>
			</div>

			<div class="col-12 col-lg-9">
				<h1 class="h4 mb-3">내 예약 내역 > 상세</h1>

				<div th:object="${reservation}">
					<h2 class="h5 mb-3" th:text="*{reservedHome.title}">숙소 제목</h2>

					<div class="d-flex justify-content-between align-items-center mb-4">
						<span th:switch="*{reservationStatus}"> <span
							th:case="REQUESTED" class="badge text-bg-secondary">예약 대기
								중</span> <span th:case="CONFIRMED" class="badge text-bg-primary">예약
								확정</span> <span th:case="IN_USE" class="badge text-bg-success">이용
								중</span> <span th:case="COMPLETED" class="badge text-bg-success">이용
								완료</span> <span th:case="CANCEL_REQUESTED"
							class="badge text-bg-warning">취소 요청 중</span> <span
							th:case="CANCELLED" class="badge text-bg-danger">취소 완료</span> <span
							th:case="REJECTED" class="badge text-bg-danger">예약 거절</span> <span
							th:case="*" class="badge text-bg-light"
							th:text="*{reservationStatus}">기타 상태</span>
						</span>

						<div
							th:if="*{reservationStatus.name() == 'CONFIRMED' or reservationStatus.name() == 'REQUESTED'}">
							<button type="button" class="btn btn-danger"
								data-bs-toggle="modal" data-bs-target="#cancelModal">
								예약 취소 신청</button>
						</div>
					</div>

					<div class="detail-section">
						<div class="detail-item">
							<span class="item-label">체크인/체크아웃</span> <span class="item-value"
								th:text="|*{startDate} ~ *{endDate}|">2025-10-01 ~
								2025-10-05</span>
						</div>
						<div class="detail-item">
							<span class="item-label">총 숙박 인원</span> <span class="item-value"
								th:text="|성인 *{adult}명, 어린이 *{child}명|">성인 2명, 어린이 1명</span>
						</div>
						<div class="detail-item">
							<span class="item-label">총 결제 금액</span> <span
								class="item-value text-primary"
								th:text="|${#numbers.formatInteger(reservation.totalMoney, 3, 'COMMA')}원|">500,000원</span>
						</div>
						<div class="detail-item">
							<span class="item-label">예약 날짜</span> <span class="item-value"
								th:text="${#temporals.format(reservation.reservedDate, 'yyyy-MM-dd HH:mm')}">2025-09-01
								10:30</span>
						</div>
						<div class="detail-item">
							<span class="item-label">결제 수단</span> <span class="item-value"
								th:text="*{payby.name()}">TRANSFER</span>
						</div>

						<div th:if="*{payby.name() == 'TRANSFER'}" class="detail-item">
							<span class="item-label">입금 계좌 정보</span> <span class="item-value"
								th:text="|*{bank} / *{account}|">국민은행 / 123456789</span>
						</div>

						<div class="detail-item"
							th:if="*{message != null and !message.isEmpty()}">
							<span class="item-label">호스트에게 보내는 메시지</span> <span
								class="item-value" th:text="*{message}">조용히 잘 이용하겠습니다.</span>
						</div>

						<div class="detail-item"
							th:if="*{reservationStatus.name() == 'CANCEL_REQUESTED' or reservationStatus.name() == 'CANCELLED'}">
							<span class="item-label text-danger">취소 신청 사유</span> <span
								class="item-value" th:text="*{cancelMessage}"></span>
						</div>
					</div>

					<!-- 리뷰 버튼: 예약 상태가 COMPLETED일 때만 노출 -->
					<div th:if="${reservation.reservationStatus.name() == 'COMPLETED'}"
						class="mt-3 d-flex gap-2">

						<!-- 아직 리뷰 미작성 -->
						<a th:if="${guestReviewWritten == false}"
							th:href="@{/mypage/review/write(reservationId=${reservation.reservationIdx},direction='GUEST_TO_HOST')}"
							class="btn btn-outline-primary"> 리뷰 작성하기 </a>

						<!-- 이미 리뷰 작성됨 -->
						<button th:if="${guestReviewWritten == true}" type="button"
							class="btn btn-success" disabled>리뷰 작성 완료</button>
						<a th:if="${guestReviewWritten == true}"
							th:href="@{/mypage/review/detail(reservationId=${reservation.reservationIdx},direction='GUEST_TO_HOST')}"
							class="btn btn-outline-secondary"> 내 리뷰 보기 </a>
					</div>

					<div class="text-center mt-4">
						<a th:href="@{/home/detail/{idx}(idx=*{reservedHome.idx})}"
							class="btn btn-outline-primary"> 숙소 상세 페이지로 이동 </a>
					</div>

				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="cancelModal" tabindex="-1"
		aria-labelledby="cancelModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="cancelModalLabel">예약 취소 신청 확인</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					정말로 예약을 취소 신청하시겠습니까?<br> 취소는 호스트의 승인이 필요하며, 취소 수수료가 발생할 수
					있습니다.

					<div class="mt-3">
						<label for="cancelMessage" class="form-label">취소 사유 (필수)</label>
						<textarea class="form-control" id="cancelMessage"
							name="cancelMessage" rows="3" required
							placeholder="취소 사유를 입력해주세요."></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
					<form
						th:action="@{/mypage/reservation/cancel/{idx}(idx=${reservation.reservationIdx})}"
						method="post">
						<input type="hidden" name="reservationIdx"
							th:value="${reservation.reservationIdx}">
						<textarea name="cancelMessage" style="display: none;"></textarea>
						<script>
            document.addEventListener('DOMContentLoaded', function() {
              const modalForm = document.querySelector('#cancelModal form');
              const modalTextarea = document.getElementById('cancelMessage');
              const formHiddenTextarea = modalForm.querySelector('textarea[name="cancelMessage"]');
              
              modalForm.addEventListener('submit', function(e) {
                // 모달의 입력값을 form 내부의 hidden 필드에 복사하여 전송
                formHiddenTextarea.value = modalTextarea.value;
              });
            });
          </script>

						<button type="submit" class="btn btn-danger">취소 신청</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
