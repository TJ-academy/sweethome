<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>일정 관리 달력 | 마이페이지</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
	crossorigin="anonymous">
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
	crossorigin="anonymous"></script>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css' rel='stylesheet' />

<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
<link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">

<style>
    /* 이미지와 유사한 기본 레이아웃 스타일 */
    .main-container { padding: 0; } /* 상위 div에 이미 패딩이 있을 수 있으므로 0으로 설정 */
    .calendar-card { border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* 일정 상세 영역 스타일 */
    .schedule-detail { background-color: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .schedule-item { border-left: 5px solid; padding-left: 15px; margin-bottom: 15px; }

    /* 범례 색상 */
    .legend-item span { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .color-blue { background-color: #007bff; }
    .color-red { background-color: #dc3545; }

    /* 🚨 삭제됨: .calendar-header 관련 CSS */
    .calendar-grid { padding: 20px; }
    .date-cell { text-align: center; padding: 10px 5px; cursor: pointer; }
    .date-cell.today { font-weight: bold; color: #007bff; } /* 오늘 날짜 */
    .date-cell.event-dots::after { content: '...'; display: block; font-size: 10px; line-height: 1; color: #007bff; } /* 이벤트 표시 */
    .month-name { font-size: 24px; font-weight: 300; }
</style>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
// ⭐ 재사용 가능한 일정 로드 함수 정의
function loadSchedules(dateStr) {
    console.log('Loading schedules for: ' + dateStr);
    
    const detailBox = document.querySelector('.schedule-detail');
    // dateStr이 YYYY-MM-DD 형식임을 가정하고 날짜 객체 생성 (시간대 문제 방지 위해 T00:00:00 추가)
    const dateObj = new Date(dateStr + 'T00:00:00'); 
    const detailDay = dateObj.getDate();

    // 로딩 중 표시
    detailBox.innerHTML = `<h5><span class="text-primary">${detailDay}</span>일 일정</h5><hr><p class="text-muted">일정 로딩 중...</p>`;

    // API 호출: /api/schedules/day?date=YYYY-MM-DD
    fetch('/api/schedules/day?date=' + dateStr)
        .then(res => {
          if (!res.ok) {
            throw new Error('API 응답 오류: ' + res.status);
          }
          return res.json();
        })
        .then(list => {
          let html = `<h5><span class="text-primary">${detailDay}</span>일 일정</h5><hr>`;
          
          if (!list || list.length === 0) {
            html += `<p class="text-muted">일정이 없습니다.</p>`;
          } else {
        	  list.forEach(item => {
        		  const memoText = item.memoForHost ? item.memoForHost : '';

        		  if (item.checkInTime) {
        		    const checkInHHmm = new Date(item.checkInTime).toTimeString().substring(0, 5);
        		    html += `
        		      <div class="schedule-item" style="border-left-color:#007bff;"
        		           data-reservation-id="${item.reservationId}"
        		           data-home-title="${item.homeTitle}"
        		           data-guest="${item.guestNickname}"
        		           data-memo="${(memoText || '').replace(/"/g, '&quot;')}">
        		        <p class="mb-1 d-flex align-items-center justify-content-between">
        		          <span>
        		            <span class="badge text-bg-primary me-2">${checkInHHmm}</span>
        		            <span>게스트 ${item.guestNickname} 님 ${item.homeTitle} 체크인</span>
        		          </span>
        		          <button type="button" class="btn btn-sm btn-outline-secondary btn-memo-edit">메모</button>
        		        </p>
        		        ${memoText ? `<small class="text-muted d-block ms-4">메모: ${memoText}</small>` : `<small class="text-muted d-block ms-4">메모 없음</small>`}
        		      </div>
        		    `;
        		  }

        		  if (item.checkOutTime) {
        		    const checkOutHHmm = new Date(item.checkOutTime).toTimeString().substring(0, 5);
        		    html += `
        		      <div class="schedule-item" style="border-left-color:#dc3545;"
        		           data-reservation-id="${item.reservationId}"
        		           data-home-title="${item.homeTitle}"
        		           data-guest="${item.guestNickname}"
        		           data-memo="${(memoText || '').replace(/"/g, '&quot;')}">
        		        <p class="mb-1 d-flex align-items-center justify-content-between">
        		          <span>
        		            <span class="badge text-bg-secondary me-2">${checkOutHHmm}</span>
        		            <span>게스트 ${item.guestNickname} 님 ${item.homeTitle} 체크아웃</span>
        		          </span>
        		          <button type="button" class="btn btn-sm btn-outline-secondary btn-memo-edit">메모</button>
        		        </p>
        		        ${memoText ? `<small class="text-muted d-block ms-4">메모: ${memoText}</small>` : `<small class="text-muted d-block ms-4">메모 없음</small>`}
        		      </div>
        		    `;
        		  }
        		});


        	  
        	  
        	  /*
            list.forEach(item => {
              // Time 추출 (LocalDateTime 객체에서 ISO 8601 형식으로 와야 함)
              const checkInHHmm  = item.checkInTime ? new Date(item.checkInTime).toTimeString().substring(0, 5) : '15:00';
              const checkOutHHmm = item.checkOutTime ? new Date(item.checkOutTime).toTimeString().substring(0, 5) : '11:00';

              // 체크인 항목 추가 (파란색)
              html += `
                <div class="schedule-item" style="border-left-color:#007bff;">
                  <p class="mb-1">
                    <span class="badge text-bg-primary me-2">${checkInHHmm}</span>
                    <span>게스트 ${item.guestNickname} 님 ${item.homeTitle} 체크인</span>
                  </p>
                  ${item.memoForHost ? `<small class="text-muted d-block ms-4">${item.memoForHost}</small>` : ''}
                </div>
              `;
              
              // 체크아웃 항목 추가 (빨간색)
              html += `
                <div class="schedule-item" style="border-left-color:#dc3545;">
                  <p class="mb-1">
                    <span class="badge text-bg-secondary me-2">${checkOutHHmm}</span>
                    <span>게스트 ${item.guestNickname} 님 ${item.homeTitle} 체크아웃</span>
                  </p>
                </div>
              `;
            });
        	  */
          }
          detailBox.innerHTML = html; // 우측 패널 갱신
        })
        .catch(error => {
          console.error("일정 로딩 중 오류:", error);
          detailBox.innerHTML = `<h5><span class="text-primary">${detailDay}</span>일 일정</h5><hr><p class="text-danger">일정 로딩에 실패했습니다.</p>`;
        });
}

document.addEventListener('DOMContentLoaded', function() {
	let currentDateStr = null;        // 마지막으로 본 날짜(새로고침 용)
	let currentReservationId = null;  // 모달에서 편집할 예약 ID

	function openMemoModal(el) {
	  const rid = el.closest('.schedule-item').dataset.reservationId;
	  const homeTitle = el.closest('.schedule-item').dataset.homeTitle;
	  const guest = el.closest('.schedule-item').dataset.guest;
	  const memo = el.closest('.schedule-item').dataset.memo || '';

	  currentReservationId = rid;
	  document.getElementById('memoTextarea').value = memo;
	  document.getElementById('memoModalInfo').textContent = `${homeTitle} · ${guest}`;
	  const modal = new bootstrap.Modal(document.getElementById('memoModal'));
	  modal.show();
	}

	async function saveMemo() {
	  const memo = document.getElementById('memoTextarea').value;
	  const res = await fetch(`/api/reservations/${currentReservationId}/memo`, {
	    method: 'PUT',
	    headers: { 'Content-Type': 'application/json' },
	    body: JSON.stringify({ memo })
	  });
	  if (!res.ok) {
	    alert('메모 저장 실패');
	    return;
	  }
	  bootstrap.Modal.getInstance(document.getElementById('memoModal')).hide();
	  // 방금 본 날짜 재조회
	  if (currentDateStr) loadSchedules(currentDateStr);
	}

	async function deleteMemo() {
	  if (!confirm('메모를 삭제할까요?')) return;
	  const res = await fetch(`/api/reservations/${currentReservationId}/memo`, { method: 'DELETE' });
	  if (!res.ok) {
	    alert('메모 삭제 실패');
	    return;
	  }
	  bootstrap.Modal.getInstance(document.getElementById('memoModal')).hide();
	  if (currentDateStr) loadSchedules(currentDateStr);
	}

	document.addEventListener('DOMContentLoaded', function() {
	  // 기존 코드...

	  // 오늘 날짜 기억
	  const today = new Date();
	  const year = today.getFullYear();
	  const month = String(today.getMonth() + 1).padStart(2, '0');
	  const day = String(today.getDate()).padStart(2, '0');
	  currentDateStr = `${year}-${month}-${day}`;

	  // 일정 클릭 → 메모 모달
	  document.querySelector('.schedule-detail').addEventListener('click', function(e) {
	    if (e.target.classList.contains('btn-memo-edit')) {
	      openMemoModal(e.target);
	    }
	  });

	  // 모달 버튼
	  document.getElementById('btnMemoSave').addEventListener('click', saveMemo);
	  document.getElementById('btnMemoDelete').addEventListener('click', deleteMemo);

	  // loadSchedules 호출 시 마지막 날짜 기억
	  const originalLoadSchedules = window.loadSchedules;
	  window.loadSchedules = function(dateStr) {
	    currentDateStr = dateStr;
	    return originalLoadSchedules(dateStr);
	  };
	});

	
	
	
	
	
	
  var calendarEl = document.getElementById('calendar');
  
  // 1. 오늘 날짜 (YYYY-MM-DD) 계산
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const todayStr = `${year}-${month}-${day}`;


  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ko', // 한국어 설정
    headerToolbar: { 
      left: 'prev', // 이전/다음 버튼만 유지
      center: 'title',   // 제목 유지
      right: 'today,next'          // 나머지 버튼 제거
    },
    events: '/api/schedules', // Spring REST API 엔드포인트 (백엔드 연결 확인)
    
    // ⭐ dateClick 이벤트에서 새 함수 사용
    dateClick: function(info) {
      loadSchedules(info.dateStr);
    },
    
    // ⭐ 이벤트 로드 후 오늘 날짜를 선택 상태로 만듦
    datesSet: function(dateInfo) {
        // 뷰가 변경될 때마다 오늘 날짜의 이벤트를 다시 로드하도록 설정 (선택 사항)
        // loadSchedules(todayStr); 
    }
  });

  calendar.render();
  
  // ⭐ 페이지 로드 시 오늘 일정을 즉시 불러와 표시
  loadSchedules(todayStr); 
});
</script>

</head>
<body>
	<div th:insert="~{fragments/header :: menuBar}"></div>

	<div class="mypage-layout-wrap container-fluid">
		<div class="row">
			<div class="mypage-sidebar-col">
				<div th:insert="~{fragments/sidebarHost :: hostSideBar}"></div>
			</div>

			<div class="mypage-content-col">
                <div class="mypage-content-area">
                    
                    <div class="container-fluid main-container">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="p-4 bg-white calendar-card">
                                    <div id="calendar" class="calendar-grid">
                                        </div>
                                </div>
    
                                </div>
    
                            <div class="col-lg-4 mt-4 mt-lg-0">
							    <div class="schedule-detail">
							        <p class="text-muted">일정을 불러오고 있습니다.</p>
							    </div>
							</div>
							<div class="modal fade" id="memoModal" tabindex="-1" aria-hidden="true">
							<!-- Memo Edit Modal -->
							  <div class="modal-dialog modal-dialog-centered">
							    <div class="modal-content">
							      <div class="modal-header">
							        <h5 class="modal-title">메모 편집</h5>
							        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
							      </div>
							      <div class="modal-body">
							        <div class="mb-2">
							          <div class="small text-muted" id="memoModalInfo"></div>
							        </div>
							        <textarea id="memoTextarea" class="form-control" rows="6" placeholder="호스트 메모를 입력하세요..."></textarea>
							      </div>
							      <div class="modal-footer">
							        <button type="button" id="btnMemoDelete" class="btn btn-outline-danger">메모 삭제</button>
							        <button type="button" id="btnMemoSave" class="btn btn-primary">저장</button>
							      </div>
							    </div>
							  </div>
							</div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>