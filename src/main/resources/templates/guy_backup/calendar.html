<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>ì¼ì • ê´€ë¦¬ ë‹¬ë ¥ | ë§ˆì´í˜ì´ì§€</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
	crossorigin="anonymous">
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
	crossorigin="anonymous"></script>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css' rel='stylesheet' />

<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
<link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">

<style>
    /* ì´ë¯¸ì§€ì™€ ìœ ì‚¬í•œ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
    .main-container { padding: 0; } /* ìƒìœ„ divì— ì´ë¯¸ íŒ¨ë”©ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 0ìœ¼ë¡œ ì„¤ì • */
    .calendar-card { border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* ì¼ì • ìƒì„¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .schedule-detail { background-color: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .schedule-item { border-left: 5px solid; padding-left: 15px; margin-bottom: 15px; }

    /* ë²”ë¡€ ìƒ‰ìƒ */
    .legend-item span { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .color-blue { background-color: #007bff; }
    .color-red { background-color: #dc3545; }

    /* ğŸš¨ ì‚­ì œë¨: .calendar-header ê´€ë ¨ CSS */
    .calendar-grid { padding: 20px; }
    .date-cell { text-align: center; padding: 10px 5px; cursor: pointer; }
    .date-cell.today { font-weight: bold; color: #007bff; } /* ì˜¤ëŠ˜ ë‚ ì§œ */
    .date-cell.event-dots::after { content: '...'; display: block; font-size: 10px; line-height: 1; color: #007bff; } /* ì´ë²¤íŠ¸ í‘œì‹œ */
    .month-name { font-size: 24px; font-weight: 300; }
</style>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
// â­ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì¼ì • ë¡œë“œ í•¨ìˆ˜ ì •ì˜
function loadSchedules(dateStr) {
    console.log('Loading schedules for: ' + dateStr);
    
    const detailBox = document.querySelector('.schedule-detail');
    // dateStrì´ YYYY-MM-DD í˜•ì‹ì„ì„ ê°€ì •í•˜ê³  ë‚ ì§œ ê°ì²´ ìƒì„± (ì‹œê°„ëŒ€ ë¬¸ì œ ë°©ì§€ ìœ„í•´ T00:00:00 ì¶”ê°€)
    const dateObj = new Date(dateStr + 'T00:00:00'); 
    const detailDay = dateObj.getDate();

    // ë¡œë”© ì¤‘ í‘œì‹œ
    detailBox.innerHTML = `<h5><span class="text-primary">${detailDay}</span>ì¼ ì¼ì •</h5><hr><p class="text-muted">ì¼ì • ë¡œë”© ì¤‘...</p>`;

    // API í˜¸ì¶œ: /api/schedules/day?date=YYYY-MM-DD
    fetch('/api/schedules/day?date=' + dateStr)
        .then(res => {
          if (!res.ok) {
            throw new Error('API ì‘ë‹µ ì˜¤ë¥˜: ' + res.status);
          }
          return res.json();
        })
        .then(list => {
          let html = `<h5><span class="text-primary">${detailDay}</span>ì¼ ì¼ì •</h5><hr>`;
          
          if (!list || list.length === 0) {
            html += `<p class="text-muted">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          } else {
        	  list.forEach(item => {
        		  const memoText = item.memoForHost ? item.memoForHost : '';

        		  if (item.checkInTime) {
        		    const checkInHHmm = new Date(item.checkInTime).toTimeString().substring(0, 5);
        		    html += `
        		      <div class="schedule-item" style="border-left-color:#007bff;"
        		           data-reservation-id="${item.reservationId}"
        		           data-home-title="${item.homeTitle}"
        		           data-guest="${item.guestNickname}"
        		           data-memo="${(memoText || '').replace(/"/g, '&quot;')}">
        		        <p class="mb-1 d-flex align-items-center justify-content-between">
        		          <span>
        		            <span class="badge text-bg-primary me-2">${checkInHHmm}</span>
        		            <span>ê²ŒìŠ¤íŠ¸ ${item.guestNickname} ë‹˜ ${item.homeTitle} ì²´í¬ì¸</span>
        		          </span>
        		          <button type="button" class="btn btn-sm btn-outline-secondary btn-memo-edit">ë©”ëª¨</button>
        		        </p>
        		        ${memoText ? `<small class="text-muted d-block ms-4">ë©”ëª¨: ${memoText}</small>` : `<small class="text-muted d-block ms-4">ë©”ëª¨ ì—†ìŒ</small>`}
        		      </div>
        		    `;
        		  }

        		  if (item.checkOutTime) {
        		    const checkOutHHmm = new Date(item.checkOutTime).toTimeString().substring(0, 5);
        		    html += `
        		      <div class="schedule-item" style="border-left-color:#dc3545;"
        		           data-reservation-id="${item.reservationId}"
        		           data-home-title="${item.homeTitle}"
        		           data-guest="${item.guestNickname}"
        		           data-memo="${(memoText || '').replace(/"/g, '&quot;')}">
        		        <p class="mb-1 d-flex align-items-center justify-content-between">
        		          <span>
        		            <span class="badge text-bg-secondary me-2">${checkOutHHmm}</span>
        		            <span>ê²ŒìŠ¤íŠ¸ ${item.guestNickname} ë‹˜ ${item.homeTitle} ì²´í¬ì•„ì›ƒ</span>
        		          </span>
        		          <button type="button" class="btn btn-sm btn-outline-secondary btn-memo-edit">ë©”ëª¨</button>
        		        </p>
        		        ${memoText ? `<small class="text-muted d-block ms-4">ë©”ëª¨: ${memoText}</small>` : `<small class="text-muted d-block ms-4">ë©”ëª¨ ì—†ìŒ</small>`}
        		      </div>
        		    `;
        		  }
        		});


        	  
        	  
        	  /*
            list.forEach(item => {
              // Time ì¶”ì¶œ (LocalDateTime ê°ì²´ì—ì„œ ISO 8601 í˜•ì‹ìœ¼ë¡œ ì™€ì•¼ í•¨)
              const checkInHHmm  = item.checkInTime ? new Date(item.checkInTime).toTimeString().substring(0, 5) : '15:00';
              const checkOutHHmm = item.checkOutTime ? new Date(item.checkOutTime).toTimeString().substring(0, 5) : '11:00';

              // ì²´í¬ì¸ í•­ëª© ì¶”ê°€ (íŒŒë€ìƒ‰)
              html += `
                <div class="schedule-item" style="border-left-color:#007bff;">
                  <p class="mb-1">
                    <span class="badge text-bg-primary me-2">${checkInHHmm}</span>
                    <span>ê²ŒìŠ¤íŠ¸ ${item.guestNickname} ë‹˜ ${item.homeTitle} ì²´í¬ì¸</span>
                  </p>
                  ${item.memoForHost ? `<small class="text-muted d-block ms-4">${item.memoForHost}</small>` : ''}
                </div>
              `;
              
              // ì²´í¬ì•„ì›ƒ í•­ëª© ì¶”ê°€ (ë¹¨ê°„ìƒ‰)
              html += `
                <div class="schedule-item" style="border-left-color:#dc3545;">
                  <p class="mb-1">
                    <span class="badge text-bg-secondary me-2">${checkOutHHmm}</span>
                    <span>ê²ŒìŠ¤íŠ¸ ${item.guestNickname} ë‹˜ ${item.homeTitle} ì²´í¬ì•„ì›ƒ</span>
                  </p>
                </div>
              `;
            });
        	  */
          }
          detailBox.innerHTML = html; // ìš°ì¸¡ íŒ¨ë„ ê°±ì‹ 
        })
        .catch(error => {
          console.error("ì¼ì • ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error);
          detailBox.innerHTML = `<h5><span class="text-primary">${detailDay}</span>ì¼ ì¼ì •</h5><hr><p class="text-danger">ì¼ì • ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
        });
}

document.addEventListener('DOMContentLoaded', function() {
	let currentDateStr = null;        // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ë‚ ì§œ(ìƒˆë¡œê³ ì¹¨ ìš©)
	let currentReservationId = null;  // ëª¨ë‹¬ì—ì„œ í¸ì§‘í•  ì˜ˆì•½ ID

	function openMemoModal(el) {
	  const rid = el.closest('.schedule-item').dataset.reservationId;
	  const homeTitle = el.closest('.schedule-item').dataset.homeTitle;
	  const guest = el.closest('.schedule-item').dataset.guest;
	  const memo = el.closest('.schedule-item').dataset.memo || '';

	  currentReservationId = rid;
	  document.getElementById('memoTextarea').value = memo;
	  document.getElementById('memoModalInfo').textContent = `${homeTitle} Â· ${guest}`;
	  const modal = new bootstrap.Modal(document.getElementById('memoModal'));
	  modal.show();
	}

	async function saveMemo() {
	  const memo = document.getElementById('memoTextarea').value;
	  const res = await fetch(`/api/reservations/${currentReservationId}/memo`, {
	    method: 'PUT',
	    headers: { 'Content-Type': 'application/json' },
	    body: JSON.stringify({ memo })
	  });
	  if (!res.ok) {
	    alert('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨');
	    return;
	  }
	  bootstrap.Modal.getInstance(document.getElementById('memoModal')).hide();
	  // ë°©ê¸ˆ ë³¸ ë‚ ì§œ ì¬ì¡°íšŒ
	  if (currentDateStr) loadSchedules(currentDateStr);
	}

	async function deleteMemo() {
	  if (!confirm('ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
	  const res = await fetch(`/api/reservations/${currentReservationId}/memo`, { method: 'DELETE' });
	  if (!res.ok) {
	    alert('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨');
	    return;
	  }
	  bootstrap.Modal.getInstance(document.getElementById('memoModal')).hide();
	  if (currentDateStr) loadSchedules(currentDateStr);
	}

	document.addEventListener('DOMContentLoaded', function() {
	  // ê¸°ì¡´ ì½”ë“œ...

	  // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì–µ
	  const today = new Date();
	  const year = today.getFullYear();
	  const month = String(today.getMonth() + 1).padStart(2, '0');
	  const day = String(today.getDate()).padStart(2, '0');
	  currentDateStr = `${year}-${month}-${day}`;

	  // ì¼ì • í´ë¦­ â†’ ë©”ëª¨ ëª¨ë‹¬
	  document.querySelector('.schedule-detail').addEventListener('click', function(e) {
	    if (e.target.classList.contains('btn-memo-edit')) {
	      openMemoModal(e.target);
	    }
	  });

	  // ëª¨ë‹¬ ë²„íŠ¼
	  document.getElementById('btnMemoSave').addEventListener('click', saveMemo);
	  document.getElementById('btnMemoDelete').addEventListener('click', deleteMemo);

	  // loadSchedules í˜¸ì¶œ ì‹œ ë§ˆì§€ë§‰ ë‚ ì§œ ê¸°ì–µ
	  const originalLoadSchedules = window.loadSchedules;
	  window.loadSchedules = function(dateStr) {
	    currentDateStr = dateStr;
	    return originalLoadSchedules(dateStr);
	  };
	});

	
	
	
	
	
	
  var calendarEl = document.getElementById('calendar');
  
  // 1. ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD) ê³„ì‚°
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const todayStr = `${year}-${month}-${day}`;


  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
    headerToolbar: { 
      left: 'prev', // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ë§Œ ìœ ì§€
      center: 'title',   // ì œëª© ìœ ì§€
      right: 'today,next'          // ë‚˜ë¨¸ì§€ ë²„íŠ¼ ì œê±°
    },
    events: '/api/schedules', // Spring REST API ì—”ë“œí¬ì¸íŠ¸ (ë°±ì—”ë“œ ì—°ê²° í™•ì¸)
    
    // â­ dateClick ì´ë²¤íŠ¸ì—ì„œ ìƒˆ í•¨ìˆ˜ ì‚¬ìš©
    dateClick: function(info) {
      loadSchedules(info.dateStr);
    },
    
    // â­ ì´ë²¤íŠ¸ ë¡œë“œ í›„ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ì„ íƒ ìƒíƒœë¡œ ë§Œë“¦
    datesSet: function(dateInfo) {
        // ë·°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì˜¤ëŠ˜ ë‚ ì§œì˜ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ë„ë¡ ì„¤ì • (ì„ íƒ ì‚¬í•­)
        // loadSchedules(todayStr); 
    }
  });

  calendar.render();
  
  // â­ í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ì¼ì •ì„ ì¦‰ì‹œ ë¶ˆëŸ¬ì™€ í‘œì‹œ
  loadSchedules(todayStr); 
});
</script>

</head>
<body>
	<div th:insert="~{fragments/header :: menuBar}"></div>

	<div class="mypage-layout-wrap container-fluid">
		<div class="row">
			<div class="mypage-sidebar-col">
				<div th:insert="~{fragments/sidebarHost :: hostSideBar}"></div>
			</div>

			<div class="mypage-content-col">
                <div class="mypage-content-area">
                    
                    <div class="container-fluid main-container">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="p-4 bg-white calendar-card">
                                    <div id="calendar" class="calendar-grid">
                                        </div>
                                </div>
    
                                </div>
    
                            <div class="col-lg-4 mt-4 mt-lg-0">
							    <div class="schedule-detail">
							        <p class="text-muted">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
							    </div>
							</div>
							<div class="modal fade" id="memoModal" tabindex="-1" aria-hidden="true">
							<!-- Memo Edit Modal -->
							  <div class="modal-dialog modal-dialog-centered">
							    <div class="modal-content">
							      <div class="modal-header">
							        <h5 class="modal-title">ë©”ëª¨ í¸ì§‘</h5>
							        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
							      </div>
							      <div class="modal-body">
							        <div class="mb-2">
							          <div class="small text-muted" id="memoModalInfo"></div>
							        </div>
							        <textarea id="memoTextarea" class="form-control" rows="6" placeholder="í˜¸ìŠ¤íŠ¸ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
							      </div>
							      <div class="modal-footer">
							        <button type="button" id="btnMemoDelete" class="btn btn-outline-danger">ë©”ëª¨ ì‚­ì œ</button>
							        <button type="button" id="btnMemoSave" class="btn btn-primary">ì €ì¥</button>
							      </div>
							    </div>
							  </div>
							</div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>