<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>투데이 일정 | 마이페이지</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
  <link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
  <link rel="stylesheet" th:href="@{/css/host/today.css}">
</head>
<body>
<div th:insert="~{fragments/header :: menuBar}"></div>

<div class="mypage-layout-wrap container-fluid">
  <div class="row">
    <div class="mypage-sidebar-col">
      <div th:insert="~{fragments/sidebarHost :: hostSideBar}"></div>
    </div>

    <div class="mypage-content-col">
      <div class="mypage-content-area">

        <div class="host-tabs">
          <button class="tab-btn" data-tab="today" th:classappend="${currentTab == 'today' ? 'active' : ''}">오늘</button>
          <button class="tab-btn" data-tab="upcoming" th:classappend="${currentTab == 'upcoming' ? 'active' : ''}">예정</button>
          <button class="tab-btn" data-tab="requests" th:classappend="${currentTab == 'requests' ? 'active' : ''}">예약</button>
        </div>

        <section class="host-board">
          <div class="board-header">
            <div class="board-date">오늘 날짜: <span th:text="${todayDate}">2025-10-24</span></div>
          </div>

          <div class="chip-wrap home-filter-wrap">
            <button class="chip active" data-home-idx="all">전체 숙소</button>
            <button class="chip" th:each="home : ${myHomes}" th:text="${home.title}" th:attr="data-home-idx=${home.idx}"></button>
          </div>

          <div class="chip-wrap status-filter-wrap" id="filter-today" th:classappend="${currentTab != 'today' ? 'hidden' : ''}">
              <button class="chip status-chip active" data-status="all">전체 오늘 일정</button>
              <button class="chip status-chip" data-status="checkin">오늘 체크인 예정</button>
              <button class="chip status-chip" data-status="inuse">숙박 중</button>
              <button class="chip status-chip" data-status="checkout">오늘 체크아웃 예정</button>
          </div>

          <div class="chip-wrap period-filter-wrap hidden" id="filter-upcoming" th:classappend="${currentTab == 'upcoming' ? '' : 'hidden'}">
              <button class="chip period-chip active" data-period="30">30일 이내</button>
              <button class="chip period-chip" data-period="7">7일 이내</button>
              <button class="chip period-chip" data-period="3">3일 이내</button>
          </div>

          <div class="chip-wrap request-filter-wrap hidden" id="filter-requests" th:classappend="${currentTab == 'requests' ? '' : 'hidden'}">
              <button class="chip request-chip active" data-request-type="all">전체 요청</button>
              <button class="chip request-chip" data-request-type="requested">예약 요청</button>
              <button class="chip request-chip" data-request-type="cancel">취소 요청</button>
          </div>

          <div class="board-table">
            <table class="table booking-table">
              <thead>
                <tr>
                  <th>숙소</th>
                  <th>게스트</th>
                  <th>체크인/체크아웃</th>
                  <th>상태</th>
                  <th>관리</th>
                </tr>
              </thead>

              <tbody id="reservation-list">
                <!-- 오늘 예약 목록 -->
                <th:block th:each="r : ${todayReservations}">
                  <tr th:data-tab="today"
                      th:data-home-idx="${r.reservedHome.idx}"
                      th:attr="data-status-category=${#strings.equals(#temporals.format(r.startDate, 'yyyy-MM-dd'), todayDate) ? 'checkin' :
                      (#strings.equals(#temporals.format(r.endDate, 'yyyy-MM-dd'), todayDate) ? 'checkout' : 'inuse')}">
                    <!-- 예약 정보를 표시하는 fragment 삽입 -->
                    <th:block th:insert="~{host/today :: reservationRowContent(r=${r})}"></th:block>
                  </tr>
                </th:block>

                <!-- 예정 예약 목록 -->
                <th:block th:each="r : ${upcomingReservations}">
                  <tr th:data-tab="upcoming"
                      th:data-home-idx="${r.reservedHome.idx}"
                      th:attr="data-start-date=${#temporals.format(r.startDate, 'yyyyMMdd')}"
                      th:classappend="${currentTab == 'upcoming' ? '' : 'hidden'}">
                    <!-- 예약 정보를 표시하는 fragment 삽입 -->
                    <th:block th:insert="~{host/today :: reservationRowContent(r=${r})}"></th:block>
                  </tr>
                </th:block>

                <!-- 예약 요청 목록 -->
                <th:block th:each="r : ${requestReservations}">
                  <tr th:data-tab="requests"
                      th:data-home-idx="${r.reservedHome.idx}"
                      th:attr="data-request-type=${r.reservationStatus.name() == 'REQUESTED' ? 'requested' : 'cancel'}"
                      th:classappend="${currentTab == 'requests' ? '' : 'hidden'}">
                    <!-- 예약 정보를 표시하는 fragment 삽입 -->
                    <th:block th:insert="~{host/today :: reservationRowContent(r=${r})}"></th:block>
                  </tr>
                </th:block>

                <!-- 예약이 없을 때 표시할 메시지 -->
                <tr id="empty-message-row" class="hidden">
                  <td colspan="5" class="text-center p-4 text-muted">선택된 조건에 맞는 예약이 없습니다.</td>
                </tr>

              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<!-- 예약 행을 처리하는 fragment 정의 -->
<th:block th:fragment="reservationRowContent(r)">
    <td>
        <a th:href="@{|/host/reservation/detail/${r != null ? r.reservationIdx : ''}|}">
            <div class="home-cell">
                <div class="home-title" th:text="${r != null ? r.reservedHome.title : 'Unknown Home'}">평온한 집</div>
                <div class="home-meta" th:text="${r != null ? r.reservedHome.location : 'Unknown Location'}">수원시</div>
            </div>
        </a>
    </td>
    
    <td>
        <a th:href="@{|/host/reservation/detail/${r != null ? r.reservationIdx : ''}|}" 
           th:text="${r != null ? r.booker.nickname : 'Unknown Guest'}">게스트 닉네임</a>
    </td>
    
    <td>
        <span th:text="${r != null ? #temporals.format(r.startDate, 'MM/dd') : 'MM/DD'}">10/30</span>
        ~
        <span th:text="${r != null ? #temporals.format(r.endDate, 'MM/dd') : 'MM/DD'}">11/02</span>
    </td>
    
    <td>
      <span th:if="${r != null && r.reservationStatus.name() == 'CONFIRMED'}" class="badge-soft pink">예약 확정</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'IN_USE'}" class="badge-soft gray">숙박 중</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'COMPLETED'}" class="badge-soft success">이용 완료</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'REQUESTED'}" class="badge-soft warning">요청 대기</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'CANCEL_REQUESTED'}" class="badge-soft warning">취소 요청</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'CANCELLED'}" class="badge-soft gray">취소 완료</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'REJECTED'}" class="badge-soft gray">예약 거절</span>
    </td>
    
    <td>
        <a th:href="@{|/host/reservation/detail/${r != null ? r.reservationIdx : ''}|}" class="btn btn-outline-primary btn-sm">상세</a>
    </td>
</th:block>


<script th:inline="javascript">
    /* <![CDATA[ */
    const TODAY_DATE_YMD = '[[${#temporals.format(todayDate, "yyyyMMdd")}]]';
    const rows = document.querySelectorAll('#reservation-list tr[data-tab]');
    const emptyMessageRow = document.getElementById('empty-message-row');
    let activeTab = 'today';
    let activeHomeIdx = 'all';

    // 1. 메인 탭 전환 및 필터 초기화
    document.querySelectorAll('.host-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.host-tabs .tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            activeTab = e.target.getAttribute('data-tab');

            // 탭별 필터 영역 표시/숨김
            document.getElementById('filter-today').classList.add('hidden');
            document.getElementById('filter-upcoming').classList.add('hidden');
            document.getElementById('filter-requests').classList.add('hidden');
            document.getElementById('filter-' + activeTab).classList.remove('hidden');
            
            // 숙소 필터를 '전체'로 초기화
            document.querySelectorAll('.home-filter-wrap .chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('.home-filter-wrap .chip[data-home-idx="all"]').classList.add('active');
            activeHomeIdx = 'all';

            // 탭별 내부 필터 '전체' 또는 기본값으로 초기화
            document.querySelectorAll('#filter-' + activeTab + ' .chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('#filter-' + activeTab + ' .chip:first-child').classList.add('active');

            updateReservationList();
        });
    });

    // 2. 통합 필터링 로직 함수
    function updateReservationList() {
        let visibleCount = 0;
        
        // 현재 탭의 내부 필터 값 가져오기
        const activeInnerFilter = document.querySelector('#filter-' + activeTab + ' .chip.active');
        const filterValue = activeInnerFilter ? (activeTab === 'upcoming' ? activeInnerFilter.getAttribute('data-period') : activeInnerFilter.getAttribute('data-status') || activeInnerFilter.getAttribute('data-request-type')) : 'all';
        
        // 오늘 날짜 계산 (예정 탭 필터링 기준)
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        rows.forEach(row => {
            const rowTab = row.getAttribute('data-tab');
            const rowHomeIdx = row.getAttribute('data-home-idx');
            
            let isVisible = true;

            // 1) 메인 탭 필터링
            if (rowTab !== activeTab) {
                isVisible = false;
            }

            // 2) 숙소 필터링
            if (isVisible && activeHomeIdx !== 'all' && rowHomeIdx !== activeHomeIdx) {
                isVisible = false;
            }

            // 3) 내부 필터링 (탭별 로직)
            if (isVisible) {
                if (activeTab === 'today') {
                    const rowStatusCategory = row.getAttribute('data-status-category');
                    if (filterValue !== 'all' && rowStatusCategory !== filterValue) {
                        isVisible = false;
                    }
                } else if (activeTab === 'upcoming') {
                    const rowStartDateStr = row.getAttribute('data-start-date'); // YYYYMMDD
                    const periodDays = parseInt(filterValue, 10);
                    
                    if (periodDays !== 30) { // 30일 이내는 기본적으로 가져온 데이터 전체를 의미
                        const rowStartDate = new Date(rowStartDateStr.substring(0, 4), rowStartDateStr.substring(4, 6) - 1, rowStartDateStr.substring(6, 8));
                        
                        const diffTime = rowStartDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays > periodDays || diffDays <= 0) {
                            isVisible = false;
                        }
                    }
                } else if (activeTab === 'requests') {
                    const rowRequestType = row.getAttribute('data-request-type');
                    if (filterValue !== 'all' && rowRequestType !== filterValue) {
                        isVisible = false;
                    }
                }
            }
            
            // 최종 표시/숨김
            row.classList.toggle('hidden', !isVisible);
            if (isVisible) {
                visibleCount++;
            }
        });
        
        // 예약 없음 메시지 처리
        emptyMessageRow.classList.toggle('hidden', visibleCount > 0);
    }
    
    // 3. 숙소 필터 이벤트 리스너 (공통)
    document.querySelectorAll('.home-filter-wrap .chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            activeHomeIdx = e.target.getAttribute('data-home-idx');
            updateReservationList();
        });
    });

    // 4. 내부 필터 이벤트 리스너 (탭별)
    document.querySelectorAll('.status-chip, .period-chip, .request-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            // 같은 칩 그룹의 active 상태를 관리
            e.target.parentElement.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            updateReservationList();
        });
    });
    
    // 페이지 로드 시 초기 탭 상태에 맞춰 목록 표시
    updateReservationList();

    /* ]]> */
</script>
</body>
</html>
