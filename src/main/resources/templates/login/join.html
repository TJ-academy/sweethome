<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>회원가입</title>

<script>
function isValidEmail(email) {
    // 이메일 유효성 검사
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

//인증 코드 전송
function sendVerificationCode() {
    const email = document.getElementById("email").value;
    const emailResult = document.getElementById("verificationResult")
    
 	// 이메일 형식이 올바른지 확인
    if (!isValidEmail(email)) {
        alert("올바른 이메일 주소를 입력해주세요.");
        return;
    }
 	
 	// 이메일 중복 확인
    fetch("/user/checkEmailDuplicate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "email=" + encodeURIComponent(email)
    })
    .then(res => res.text())
    .then(status => {
        if (status === "duplicate") {
            alert("이미 존재하는 이메일입니다.");
            return;
        }
        
        //이메일 보내는 중~
        emailResult.innerText = "인증 코드 보내는 중..";
        emailResult.style.color = "black";
        document.getElementById("emailBtn").disabled = true;
        
		//중복이 아니면 이메일 인증 요청
        return fetch("/user/mailConfirm", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "email=" + encodeURIComponent(email)
        });
    })
	.then(res => res.text())
	.then(msg => {   //이메일 보내기 완료
		emailResult.innerText = msg;
		if(msg === "메일이 전송되었습니다."){
			emailResult.style.color = "blue";
			document.getElementById("emailCode").disabled = false;
	        document.getElementById("codeBtn").disabled = false;
		} else {
			emailResult.style.color = "red";
		}
		document.getElementById("emailBtn").disabled = false;
	})
	.catch(err => {
		emailResult.innerText = "오류가 발생했습니다. 다시 시도해주세요.";
		emailResult.style.color = "red";
        console.error(err);
    });
}

//인증 코드 확인 함수
function verifyCode() {
    const code = document.getElementById("emailCode").value;
    const emailResult = document.getElementById("verificationResult");

    fetch("/user/verifyEmailCode?inputCode=" + code, {
        method: "POST"
    })
    .then(res => res.text())
    .then(msg => {
    	console.log(msg);
    	emailResult.innerText = msg;
    	emailResult.style.color = "red";
        if (msg === "인증이 완료되었습니다.") {
        	emailResult.style.color = "blue";
            document.getElementById("email").readOnly = true;
            document.getElementById("emailBtn").disabled = true;
            document.getElementById("emailCode").disabled = true;
            document.getElementById("codeBtn").disabled = true;
            document.getElementById("joinBtn").disabled = false;
            console.log("설정 완료");
            updateJoinButtonState();
        }
    });
}

let nicknameChecked = false; // 중복 확인 여부 상태 저장

function nicknameDupli() {
    const nickname = document.getElementById("nickname").value;
    if (!nickname.trim()) {
        alert("닉네임을 입력해주세요.");
        return;
    }

    fetch("/user/checkNicknameDuplicate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "nickname=" + encodeURIComponent(nickname)
    })
    .then(res => res.text())
    .then(result => {
        const nresult = document.getElementById("nicknameResult");
        if (result === "duplicate") {
            nresult.innerText = "이미 사용 중인 닉네임입니다.";
            nresult.style.color = "red";
            nicknameChecked = false;
        } else {
            nresult.innerText = "사용 가능한 닉네임입니다.";
            nresult.style.color = "blue";
            nicknameChecked = true;
            document.getElementById("nicknameBtn").disabled = true;
        }
        updateJoinButtonState();
    })
    .catch(err => {
        console.error(err);
        alert("닉네임 중복 확인 중 오류가 발생했습니다.");
        nicknameChecked = false;
        updateJoinButtonState();
    });
}

function autoHyphenPhone(target) {
    target.value = target.value
        .replace(/[^0-9]/g, '')  //숫자 외 문자 제거
        .replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);  //전화번호 형식
}

document.addEventListener('DOMContentLoaded', () => {
	//전화번호 하이픈 처리
    const phoneInput = document.getElementById('phone');
	//프사 미리보기
	const profileInput = document.getElementById('profileImgFile');
    
    phoneInput.addEventListener('input', () => {
        autoHyphenPhone(phoneInput);
    });
    
    //닉네임 변경 시 중복확인 상태 초기화
    const nicknameInput = document.getElementById("nickname");
    nicknameInput.addEventListener("input", () => {
        nicknameChecked = false;
        document.getElementById("nicknameResult").innerText = "닉네임 중복 확인이 필요합니다.";
        document.getElementById("nicknameResult").style.color = "gray";
        document.getElementById("nicknameBtn").disabled = false;
        updateJoinButtonState();
    });
    
    if (profileInput) {
        profileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('profilePreview');
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '#';
                preview.style.display = 'none';
            }
        });
    }
});

//가입하기 버튼 활성화 여부
function updateJoinButtonState() {
    const emailVerified = document.getElementById("email").readOnly; 
    const joinBtn = document.getElementById("joinBtn");

    joinBtn.disabled = !(emailVerified && nicknameChecked);
}
</script>


<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link rel="stylesheet" th:href="@{/css/user/join.css}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
</head>

<body>
<div th:insert="fragments/header :: menuBar"></div>


<div class="join-page">
  <div class="join-card">
    <h1 class="join-title">회원가입</h1>

    <form th:action="@{/user/join}" method="post" enctype="multipart/form-data">
      
      <!-- 이메일 + 버튼 -->
      <div class="input-row-wrap">
        <input type="email" id="email" name="email"
          placeholder="이메일"
          th:value="${user != null ? user.email : (kakaouser != null ? kakaouser.kakaoAccount.email : '')}"
          th:readonly="${kakaouser != null or session.emailVerified == true}"
          required>
        <button type="button" id="emailBtn"
          th:disabled="${kakaouser != null}"
          onclick="sendVerificationCode()">인증</button>
      </div>

      <!-- 인증코드 + 확인 버튼 -->
      <div class="input-row-wrap">
        <input type="text" id="emailCode"
          placeholder="인증 코드 입력"
          th:value="${kakaouser != null ? '인증완료' : ''}" disabled>
        <button type="button" id="codeBtn" onclick="verifyCode()" disabled>확인</button>
      </div>

      <!-- 인증 결과 -->
      <p id="verificationResult"
        th:text="${kakaouser != null ? '인증이 완료되었습니다.' : ''}"
        class="form-msg"></p>

      <!-- 비밀번호 -->
      <div class="input-row">
        <input type="password" id="password" name="password"
          placeholder="비밀번호"
          th:value="${user != null ? user.password : ''}" required>
      </div>

      <!-- 이름 -->
      <div class="input-row">
        <input type="text" id="username" name="username"
          placeholder="이름"
          th:value="${user != null ? user.username : ''}" required>
      </div>

      <!-- 닉네임 + 중복확인 -->
      <div class="input-row-wrap">
        <input type="text" id="nickname" name="nickname"
          placeholder="닉네임"
          th:value="${user != null ? user.nickname : (kakaouser != null ? kakaouser.kakaoAccount.profile.nickname : '')}" required>
        <button type="button" id="nicknameBtn" onclick="nicknameDupli()">확인</button>
      </div>
      <p id="nicknameResult" class="form-msg"></p>

      <!-- 프로필 -->
      <div class="profile-section">
        <p>프로필 이미지</p>

        <!-- 카카오 계정 + 프사 동의 -->
        <div th:if="${kakaouser != null and kakaouser.kakaoAccount.profile.thumbnailImageUrl != null}">
          <img th:src="${kakaouser.kakaoAccount.profile.thumbnailImageUrl}" alt="카카오 프로필 이미지" width="70" height="70" style="border-radius:50%;">
          <input type="hidden" name="profileImg"
                 th:value="${kakaouser.kakaoAccount.profile.thumbnailImageUrl}" />
        </div>

        <!-- 직접 업로드 -->
        <div th:if="${kakaouser == null or kakaouser.kakaoAccount.profile.thumbnailImageUrl == null}">
          <input type="file" id="profileImgFile" name="profileImgFile">
          <img id="profilePreview" src="#" alt="미리보기" style="display:none;">
        </div>
      </div>

      <!-- 전화번호 -->
      <div class="input-row">
        <input type="text" id="phone" name="phone"
          placeholder="전화번호"
          th:value="${user != null ? user.phone : ''}" required>
      </div>

      <!-- 생년월일 -->
      <div class="input-row">
        <input type="date" id="birthday" name="birthday"
          th:value="${user != null ? user.birthday : ''}" required>
      </div>

      <!-- 가입 버튼 -->
      <button type="submit" id="joinBtn" class="btn-primary" disabled>가입하기</button>
    </form>

    <div class="login-links">
      <a th:href="@{/user/cancelJoin}">홈으로 돌아가기</a>
    </div>
  </div>
</div>
</body>
</html>