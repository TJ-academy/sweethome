<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</title>

<!-- ğŸ”¹ CSS ì—°ê²° -->
<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link rel="stylesheet" th:href="@{/css/user/findPwd.css}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<script>
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// ì¸ì¦ ì½”ë“œ ì „ì†¡
function sendVerificationCode() {
    const email = document.getElementById("email").value;
    const result = document.getElementById("verificationResult");

    if (!isValidEmail(email)) {
        alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    fetch("/user/checkEmailDuplicate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "email=" + encodeURIComponent(email)
    })
    .then(res => res.text())
    .then(status => {
        if (status === "ok") {
            result.innerText = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.";
            result.className = "result-msg error bold";
            return;
        }

        result.innerText = "ì¸ì¦ ì½”ë“œ ë³´ë‚´ëŠ” ì¤‘...";
        result.className = "result-msg";

        return fetch("/user/mailConfirm", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "email=" + encodeURIComponent(email)
        });
    })
    .then(res => res ? res.text() : null)
    .then(msg => {
        if (!msg) return;

        if (msg.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")) {
            result.className = "result-msg error bold";
        } else if (msg.includes("ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")) {
            result.className = "result-msg ok";
        } else {
            result.className = "result-msg";
        }
        result.innerText = msg;
    });
}

// ì¸ì¦ ì½”ë“œ í™•ì¸
function verifyCode() {
    const code = document.getElementById("emailCode").value;
    const result = document.getElementById("verificationResult");

    fetch("/user/verifyEmailCode?inputCode=" + code, { method: "POST" })
    .then(res => res.text())
    .then(msg => {
        if (msg.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || msg.includes("ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")) {
            result.className = "result-msg error bold";
        } else if (msg.includes("ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")) {
            result.className = "result-msg.ok";
        } else {
            result.className = "result-msg";
        }

        result.innerText = msg;

        if (msg === "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") {
            window.location.href = "/user/resetPassword?email=" + encodeURIComponent(document.getElementById("email").value);
        }
    });
}
</script>
</head>

<body>
<div th:insert="fragments/header :: menuBar"></div>

<div class="find-page">
  <div class="find-card">
    <h2 class="find-title">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h2>

    <div class="find-form">
      <!-- ì´ë©”ì¼ ì…ë ¥ì¹¸ + ì¸ì¦ ì½”ë“œ ì „ì†¡ ë²„íŠ¼ -->
      <div class="input-group-row">
        <input type="email" id="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required>
        <button type="button" class="btn-side"
          id="emailBtn"
          th:disabled="${kakaouser != null}"
          onclick="sendVerificationCode()">ì¸ì¦ ì½”ë“œ ì „ì†¡</button>
      </div>

      <!-- ì¸ì¦ì½”ë“œ ì…ë ¥ì¹¸ + ì½”ë“œí™•ì¸ ë²„íŠ¼ -->
      <div class="input-group-row">
        <input type="text" id="emailCode"
          placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥"
          th:value="${kakaouser != null} ? 'ì¸ì¦ì™„ë£Œ' : ''"
          th:disabled="${kakaouser != null}">
        <button type="button" class="btn-side"
          id="codeBtn"
          onclick="verifyCode()"
          th:disabled="${kakaouser != null}">ì½”ë“œ í™•ì¸</button>
      </div>

      <!-- ì¸ì¦ ìƒíƒœ ë©”ì‹œì§€ -->
      <p id="verificationResult" class="result-msg"></p>
    </div>
  </div>
</div>

</body>
</html>
