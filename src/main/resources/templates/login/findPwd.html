<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</title>

<!-- ğŸ”¹ CSS ì—°ê²° -->
<link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
<link rel="stylesheet" th:href="@{/css/user/findPwd.css}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<script>
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// ì¸ì¦ ì½”ë“œ ì „ì†¡
function sendVerificationCode() {
    const email = document.getElementById("email").value;
    const result = document.getElementById("verificationResult");

    if (!isValidEmail(email)) {
        alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    fetch("/user/checkEmailDuplicate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "email=" + encodeURIComponent(email)
    })
    .then(res => res.text())
    .then(status => {
        if (status === "ok") {
            result.innerText = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.";
            result.className = "result-msg error bold";
            return;
        }

        result.innerText = "ì¸ì¦ ì½”ë“œ ë³´ë‚´ëŠ” ì¤‘...";
        result.className = "result-msg";

        return fetch("/user/mailConfirm", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "email=" + encodeURIComponent(email)
        });
    })
    .then(res => res ? res.text() : null)
    .then(msg => {
        if (!msg) return;

        if (msg.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")) {
            result.className = "result-msg error bold";
        } else if (msg.includes("ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")) {
            result.className = "result-msg ok";
        } else {
            result.className = "result-msg";
        }
        result.innerText = msg;
    });
}

// ì¸ì¦ ì½”ë“œ í™•ì¸
function verifyCode() {
    const code = document.getElementById("emailCode").value;
    const result = document.getElementById("verificationResult");

    fetch("/user/verifyEmailCode?inputCode=" + code, { method: "POST" })
    .then(res => res.text())
    .then(msg => {
        if (msg.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || msg.includes("ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")) {
            result.className = "result-msg error bold";
        } else if (msg.includes("ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")) {
            result.className = "result-msg.ok";
        } else {
            result.className = "result-msg";
        }

        result.innerText = msg;

        if (msg === "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") {
            window.location.href = "/user/resetPassword?email=" + encodeURIComponent(document.getElementById("email").value);
        }
    });
}
</script>
</head>

<body>
  <div th:insert="fragments/header :: menuBar"></div>

  <main class="reset-page">
    <section class="reset-card">
      <h1 class="reset-title">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h1>

      <form class="reset-form" action="/user/resetPassword" method="post" oninput="checkMatch()">
        <!-- í•„ìš” ì‹œ CSRF -->
        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> -->

        <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ëŒ€ìƒ ì´ë©”ì¼ -->
        <input type="hidden" name="email" th:value="${email}"/>

        <div class="reset-input-row">
          <label for="password" class="reset-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
          <div class="reset-input-with-btn">
            <input type="password" id="password" name="password" class="reset-input" minlength="8" required placeholder="8ì ì´ìƒ ì…ë ¥" />
            <button class="reset-btn-side" type="button" onclick="toggleVisibility('password', this)" aria-pressed="false">ë³´ê¸°</button>
          </div>
        </div>

        <div class="reset-input-row">
          <label for="confirmPassword" class="reset-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <div class="reset-input-with-btn">
            <input type="password" id="confirmPassword" name="confirmPassword" class="reset-input" minlength="8" required placeholder="ë‹¤ì‹œ ì…ë ¥" />
            <button class="reset-btn-side" type="button" onclick="toggleVisibility('confirmPassword', this)" aria-pressed="false">ë³´ê¸°</button>
          </div>
        </div>

        <!-- ë¼ì´ë¸Œ ê²€ì‚¬ ë©”ì‹œì§€ -->
        <p id="liveMsg" class="reset-result-msg" aria-live="polite"></p>

        <button id="submitBtn" class="reset-submit" type="submit" disabled>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
      </form>

      <!-- ì„œë²„ ì‚¬ì´ë“œ ë©”ì‹œì§€ -->
      <p th:if="${error}" th:text="${error}" class="reset-result-msg error bold"></p>
      <p th:if="${success}" th:text="${success}" class="reset-result-msg ok"></p>

      <div class="reset-links">
        <a href="/" class="reset-link">í™ˆìœ¼ë¡œ</a>
        <a href="/user/login" class="reset-link">ë¡œê·¸ì¸</a>
      </div>
    </section>
  </main>
</body>
</html>