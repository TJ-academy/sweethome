<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>채팅방</title>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<style>
/* === 전체 채팅창 반응형 === */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background-color: #e9eef6;
  font-family: 'Noto Sans KR', sans-serif;
}

#chatBox {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  height: calc(100vh - 150px);
  overflow-y: auto;
  padding: 20px 4vw; /* ✅ 화면 비율 기반 여백 */
  box-sizing: border-box;
}

/* ===== 메시지 공통 ===== */
.message {
  display: flex;
  flex-direction: column;
  margin: 8px 0;
  max-width: 60%;
  word-break: break-word;
}

/* ===== 상대방 메시지 ===== */
.message-in {
  align-self: flex-start;
  text-align: left;
}
.message-in .bubble {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 16px 16px 16px 4px;
  padding: 10px 14px;
  color: #222;
  box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

/* ===== 내 메시지 ===== */
.message-out {
  align-self: flex-end;
  text-align: right;
}
.message-out .bubble {
  background: #4DB2FF;
  color: #fff;
  border-radius: 16px 16px 4px 16px;
  padding: 10px 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

/* ===== 이미지 ===== */
.bubble img {
  display: block;
  width: 100%;
  height: auto;
  border-radius: 10px;
  margin-top: 6px;
}

/* ===== 입력창 ===== */
#chatForm {
  background-color: #e9eef6;
  padding: 14px 4vw;
  border-top: 1px solid #ccc;
  box-sizing: border-box;
}

.chat-input-wrapper {
  display: flex;
  align-items: center;
  background-color: #fff;
  border-radius: 24px;
  padding: 10px 14px;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}

#messageInput {
  flex: 1;
  border: none;
  outline: none;
  background: transparent;
  font-size: 1rem;
  resize: none;
  color: #222;
}

/* ===== 전송 버튼 ===== */
#chatForm button {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background-color: #4DB2FF;
  color: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#chatForm button:hover {
  background-color: #3ca0e6;
}

/* ===== 반응형 (화면 크기별) ===== */
@media (max-width: 1024px) {
  .message { max-width: 70%; }
  #chatBox { padding: 20px 3vw; }
}

@media (max-width: 768px) {
  #chatBox { padding: 12px 2vw; }
  .message { max-width: 80%; }
  .chat-input-wrapper { max-width: 95%; }
}

@media (max-width: 480px) {
  .message { max-width: 90%; }
  #chatForm { padding: 10px 2vw; }
}

</style>
</head>

<body>
<div class="chat-header">
  <a href="/chat/rooms">&lt; 뒤로가기</a>
  <h2 th:text="${otherNickname}"></h2>
</div>

<div id="chatBox">
  <div th:each="msg, iterStat : ${messageList}">
    <th:block th:with="currDate=${#dates.format(msg.sendedAt, 'yyyy-MM-dd')}">
      <th:block th:with="prevDate=${iterStat.index > 0} 
        ? ${#dates.format(messageList[iterStat.index - 1].sendedAt, 'yyyy-MM-dd')} 
        : ''">
        <p class="date-separator" th:if="${currDate != prevDate}"
           th:text="${#dates.format(msg.sendedAt, 'yyyy년 M월 d일 E요일')}"></p>

        <div th:id="${'msg-' + msg.msgId}"
             th:class="${msg.senderEmail == myEmail} ? 'message message-out' : 'message message-in'">
          <div class="meta" th:classappend="${msg.senderEmail == myEmail} ? ' meta-right' : ' meta-left'">
            <span class="nickname" th:text="${msg.senderNickname}"></span>
            <span class="time" th:text="${#dates.format(msg.sendedAt, 'a h:mm')}"></span>
          </div>
          <div class="bubble">
            <span th:text="${msg.content}"></span><br>
            <img th:if="${msg.img != '-'}" th:src="${msg.img}" width="200" alt="이미지">
          </div>
        </div>

        <div th:if="${msg.msgId == lastRead}
          and ${lastRead < messageList[messageList.size() - 1].msgId}">
          <hr>
          <p style="color: gray; font-style: italic; text-align:center;">여기까지 읽으셨습니다.</p>
          <hr>
        </div>
      </th:block>
    </th:block>
  </div>
</div>

<form id="chatForm">
  <div class="chat-input-wrapper">
    <label for="imageInput" class="image-upload-icon" title="이미지 업로드">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#4DB2FF" viewBox="0 0 16 16">
        <path d="M10.5 2a.5.5 0 0 1 .416.223l.823 1.234A.5.5 0 0 0 12.1 4h2.4A1.5 1.5 0 0 1 16 5.5v8A1.5 1.5 0 0 1 14.5 15h-13A1.5 1.5 0 0 1 0 13.5v-8A1.5 1.5 0 0 1 1.5 4h2.4a.5.5 0 0 0 .361-.543l.823-1.234A.5.5 0 0 1 5.5 2zM8 6a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
      </svg>
    </label>
    <textarea id="messageInput" name="content" placeholder="메시지를 입력하세요"></textarea>
    <button type="submit">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 16 16">
        <path d="M15.854.146a.5.5 0 0 1 .11.54l-6 14a.5.5 0 0 1-.924-.09L8 10.5l-6.5-1.04a.5.5 0 0 1-.09-.924l14-6a.5.5 0 0 1 .444 0z"/>
      </svg>
    </button>
  </div>

  <div id="previewContainer" style="display:none;">
    <img id="previewImage" alt="미리보기">
    <span id="removePreview">×</span>
  </div>
  <input type="file" id="imageInput" name="img" accept="image/*" hidden>
</form>

<script th:inline="javascript">
const roomId = '[[${roomId}]]';
const myNickname = '[[${myNickname}]]';
const myEmail = '[[${myEmail}]]';
const otherEmail = '[[${otherEmail}]]';
const lastRead = [[${lastRead}]];
let stompClient = null;
let lastMessageIdx = [[${#lists.isEmpty(messageList) ? 0 : messageList[messageList.size() - 1].msgId}]];

function connect() {
  const socket = new SockJS('/ws');
  stompClient = Stomp.over(socket);
  stompClient.connect({}, frame => {
    console.log('Connected: ' + frame);
    stompClient.subscribe('/topic/chat/' + roomId, msgOut => {
      const msg = JSON.parse(msgOut.body);
      showRealtimeMessage(msg);
    });
  });
}

function showRealtimeMessage(message) {
  const chatBox = document.getElementById("chatBox");
  const div = document.createElement("div");

  // 🔹 안전하게 문자열 정리
  const cleanSender = String(message.senderEmail).replaceAll('"', '').trim();
  const cleanMy = String(myEmail).replaceAll('"', '').trim();
  const isMine = cleanSender === cleanMy;

  div.className = isMine ? "message message-out" : "message message-in";

  const dateObj = new Date(message.sendedAt);
  const timeText = dateObj.toLocaleTimeString('ko-KR', {
    hour:'2-digit', minute:'2-digit', hour12:true
  });

  div.innerHTML = `
    <div class="meta ${isMine ? 'meta-right' : 'meta-left'}">
      <span class="nickname">${message.senderNickname}</span>
      <span class="time">${timeText}</span>
    </div>
    <div class="bubble">
      ${message.content.replace(/\n/g, "<br>")}
      ${message.img && message.img !== '-' ? `<br><img src="${message.img}" width="200">` : ""}
    </div>`;

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  updateLastRead(message.msgId);
}


document.getElementById("chatForm").addEventListener("submit", async e => {
  e.preventDefault();
  const input = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput");
  let imageUrl = "-";

  if (imageInput.files.length > 0) {
    const formData = new FormData();
    formData.append("image", imageInput.files[0]);
    formData.append("roomId", roomId);
    const res = await fetch("/chat/uploadImage", { method: "POST", body: formData });
    if (res.ok) {
      const result = await res.json();
      imageUrl = result.imgUrl;
    } else {
      alert("이미지 업로드 실패");
      return;
    }
  }

  const msg = input.value.trim();
  if (!msg && imageUrl === "-") return;

  sendMessage(msg, imageUrl);
  input.value = "";
  imageInput.value = "";
  document.getElementById("previewContainer").style.display = "none";
});

function sendMessage(content, img="-") {
  if (stompClient && stompClient.connected) {
    stompClient.send("/app/message/send", {}, JSON.stringify({
      roomId, senderNickname: myNickname, senderEmail: myEmail,
      receiverEmail: otherEmail, content, img
    }));
  }
}

function updateLastRead(msgId) {
  fetch('/chat/updateLastRead', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: `roomId=${roomId}&msgId=${msgId}`
  }).then(r => console.log('lastRead 업데이트', msgId));
}

const imageInput = document.getElementById("imageInput");
const previewContainer = document.getElementById("previewContainer");
const previewImage = document.getElementById("previewImage");
const removePreview = document.getElementById("removePreview");

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      previewImage.src = e.target.result;
      previewContainer.style.display = "inline-block";
    };
    reader.readAsDataURL(file);
  }
});
removePreview.addEventListener("click", () => {
  imageInput.value = "";
  previewContainer.style.display = "none";
});

(function() {
  connect();
})();
</script>
</body>
</html>
