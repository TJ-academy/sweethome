<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>채팅방</title>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<style>
  #chatBox { 
  	border: 1px solid #ccc; 
  	height: 300px; 
  	overflow-y: scroll; 
  	padding: 10px; 
  	margin-bottom: 20px;
  }
  #messageInput { width: 80%; }
  .date-separator {
    font-weight: bold;
    text-align: center;
    margin: 10px 0 10px;
  }
.message {
  max-width: 70%;
  margin-bottom: 10px;
  padding: 0px 20px;
  border-radius: 10px;
  clear: both;
}

.message-in {
  background-color: #f1f0f0;
  float: left;
  text-align: left;
  border-top-left-radius: 0;
}

.message-out {
  background-color: #dcf8c6;
  float: right;
  text-align: right;
  border-top-right-radius: 0;
}
.message-time {
  font-size: 0.8em;
  color: gray;
}
</style>
</head>
<body>
<a class="nav-link" href="/chat/rooms">뒤로가기</a>
<h2 th:text="${otherNickname}"></h2>

<div id="chatBox">
    <div th:each="msg, iterStat : ${messageList}">
    	<!-- 현재 메시지 날짜 -->
	    <th:block th:with="currDate=${#dates.format(msg.sendedAt, 'yyyy-MM-dd')}">
	      
			<!-- 이전 메시지 날짜 -->
			<th:block th:with="prevDate=${iterStat.index > 0} 
				? ${#dates.format(messageList[iterStat.index - 1].sendedAt, 'yyyy-MM-dd')} 
				: ''">
	
				<!-- 날짜가 달라졌을 때만 날짜 표시 -->
				<p class="date-separator" th:if="${currDate != prevDate}"
					th:text="${#dates.format(msg.sendedAt, 'yyyy년 M월 d일 E요일')}"></p>
				
				<!-- 메시지 출력 -->
				<div th:id="${'msg-' + msg.idx}"
					th:class="${msg.sender == myNickname} 
					? 'message message-out' 
					: 'message message-in'">
					<p>
						<strong th:text="${msg.sender}"></strong>: 
						<span th:text="${msg.content}"></span><br>
						<img th:if="${msg.img != '-'}" th:src="${msg.img}" width="200" alt="이미지">
						<span class="message-time" 
						      th:attr="data-time=${msg.sendedAt}"></span>
					</p>
				</div>
				
				<!-- 읽음 표시 -->
				<div th:if="${msg.idx == lastRead}
					and ${lastRead < messageList[messageList.size() - 1].idx}">
					<hr>
					<p style="color: gray; font-style: italic; text-align:center;">
						여기까지 읽으셨습니다.
					</p>
					<hr>
				</div>
			</th:block>
		</th:block>
    </div>
</div>


<form id="chatForm">
	<textarea id="messageInput" name="content" placeholder="메시지를 입력하세요"></textarea>
	<input type="file" id="imageInput" name="img" accept="image/*">
	<button type="submit">전송</button>
</form>

<script>
  let lastMessageIdx = [[${#lists.isEmpty(messageList) ? 0 : messageList[messageList.size() - 1].idx}]];
</script>

<script>
const textarea = document.getElementById('messageInput');
const form = document.getElementById('chatForm');
const roomId = '[[${roomId}]]';
const myNickname = '[[${myNickname}]]';
const otherNickname = '[[${otherNickname}]]';
const lastRead = [[${lastRead}]];

let stompClient = null;

textarea.addEventListener('keydown', function(event) {
	if (event.key === 'Enter' && !event.shiftKey) {
		event.preventDefault();  //줄바꿈 방지
		form.dispatchEvent(new Event('submit'));  //메시지 전송
	}
});

function connect() {
	const socket = new SockJS('/ws');
	stompClient = Stomp.over(socket);
	console.log("lastRead: " + lastRead);
	stompClient.connect({}, function (frame) {
		console.log('Connected: ' + frame);
		stompClient.subscribe('/topic/chat/' + roomId, function (messageOutput) {
			const msg = JSON.parse(messageOutput.body);
		    showMessage(msg);
		});
	});
}

//마지막 메시지 날짜
let lastMessageDate = null;

function showMessage(message) {
	const chatBox = document.getElementById('chatBox');
	const msgDate = new Date(message.sendedAt);
	lastMessageIdx = message.idx;
	
	//yyyy년 mm월 dd일 w요일
	const currentDateString = msgDate.toLocaleDateString('ko-KR', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
		weekday: 'long'
	});
	
	//날짜가 바뀌었는지
	if (lastMessageDate !== currentDateString) {
		const dateSeparator = document.createElement('p');
		dateSeparator.textContent = currentDateString;
		dateSeparator.className = 'date-separator';
		chatBox.appendChild(dateSeparator);
		lastMessageDate = currentDateString;
	}
	
	//메시지 박스 생성
    const messageDiv = document.createElement('div');
    const isMyMessage = message.sender === myNickname;
    messageDiv.className = isMyMessage ? 'message message-out' : 'message message-in';
	
	// 메시지 내용 구성
    let innerHTML = `<p>`;
    innerHTML += `<strong>${message.sender}</strong>: ${message.content}<br>`;
    
	//이미지가 있으면 출력
	if (message.img && message.img !== '-') {
		innerHTML += `<br><img src="${message.img}" width="200" alt="이미지">`;
	}
	
	//시간 출력 "오전 11:58" 형식
	const formattedTime = msgDate.toLocaleTimeString('ko-KR', {
		hour: '2-digit',
		minute: '2-digit',
		hour12: true
	});
	innerHTML += `<span class="message-time">${formattedTime}</span>`;
	innerHTML += `</p>`;
	
	messageDiv.innerHTML = innerHTML;

    // chatBox에 메시지 추가
    chatBox.appendChild(messageDiv);

    // 스크롤 하단으로
    chatBox.scrollTop = chatBox.scrollHeight;
    
    //마지막 메시지 idx 서버에 알려주기
    console.log("마지막으로 읽은 메시지: " + message.content);
    updateLastRead(message.idx);
}

//메시지 보내기
function sendMessage(content, img = '-') {
	console.log("content : " + content + "\nimg : " + img)
	if (stompClient && stompClient.connected) {
		console.log("sendMessage 함수 실행");
		stompClient.send("/app/message/send", {}, JSON.stringify({
			roomId,
			sender: myNickname,
			receiver: otherNickname,
			content,
			img
		}));
	}
}

form.addEventListener('submit', async function(e) {
	e.preventDefault();
	
	const input = textarea;
	const imageInput = document.getElementById('imageInput');
	
	let imageUrl = '-';

    if (imageInput.files.length > 0) {
    	console.log("a");
        const formData = new FormData();
        formData.append('image', imageInput.files[0]);
        formData.append('roomId', roomId);

        //이미지 업로드 API 요청
        const response = await fetch('/chat/uploadImage', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            imageUrl = result.imgUrl;  //서버에서 반환하는 이미지 URL
        } else {
            alert('이미지 업로드 실패');
            return;
        }
    }
	
	const message = input.value.trim();
	console.log("b");
	if (message || imageUrl !== '-') {
		sendMessage(message, imageUrl);
		console.log("sendMessage 함수 실행 완료");
		input.value = '';
        imageInput.value = '';
	}
});

//마지막으로 읽은 메시지
function updateLastRead(messageIdx) {
    fetch('/chat/updateLastRead', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `roomId=${roomId}&messageIdx=${messageIdx}`
    })
    .then(res => {
        if (!res.ok) {
            console.error('lastRead 업데이트 실패');
        } else {
            console.log('lastRead 업데이트 성공:', messageIdx);
        }
    })
    .catch(err => {
        console.error('lastRead 업데이트 중 오류:', err);
    });
}



(function() {
	connect();
	console.log("마지막으로 읽은 위치로   " + lastRead);
	console.log("마지막 메시지   " + lastMessageIdx);
	
    if (lastRead != null) {
    	if(lastMessageIdx != null && lastMessageIdx != lastRead) {
    		updateLastRead(lastMessageIdx);
    	}
        const tryScroll = () => {
            const el = document.getElementById('msg-' + lastRead);
            if (el) {
                el.scrollIntoView({ behavior: 'auto', block: 'start' });
            } else {
                requestAnimationFrame(tryScroll);
            }
        };
        tryScroll();
    }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
	const timeElements = document.querySelectorAll('.message-time');
	
	timeElements.forEach(el => {
		const isoTime = el.getAttribute('data-time');
		if (!isoTime) return;
		
		const date = new Date(isoTime);  //자동으로 브라우저 로컬 시간대로 변환됨
		
		const formatted = date.toLocaleTimeString('ko-KR', {
			hour: '2-digit',
			minute: '2-digit',
			hour12: true
		});
		
		el.textContent = formatted;
	});
});
</script>
</body>
</html>