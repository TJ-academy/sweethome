<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì±„íŒ…</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<link rel="stylesheet" th:href="@{/css/chat/chat.css}">


</head>

<body>
<div th:insert="fragments/header :: menuBar"></div>
<div class="container">

  <!-- ==================== ì™¼ìª½: ì±„íŒ…ë°© ëª©ë¡ ==================== -->
  <div class="chat-list">
    <div class="chat-list-header">
	  <button class="back-btn" onclick="goBack()">
	    <!-- ì™¼ìª½ í™”ì‚´í‘œ ì•„ì´ì½˜ (Bootstrap SVG) -->
	    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#4DB2FF" viewBox="0 0 16 16">
	      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
	    </svg>
	  </button>
	  <h2>ë‚´ ì±„íŒ…ë°©</h2>
	</div>

    <div th:if="${roomsList == null or #lists.isEmpty(roomsList)}" class="empty-message">
      ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <div th:each="room : ${roomsList}" class="chat-room"
         th:attr="data-room-id=${room.roomId}, data-room-name=${room.roomName}"
         onclick="openChatRoom(this)">
      <div class="profile-img">
	    <img class="chat-room-img"
	    th:src="${room.profileImg}" alt="í”„ë¡œí•„" 
	    onerror="this.src='/img/userProfile/default.png'"
	    style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
	  </div>
      <div class="room-name" th:text="${room.roomName}">ìƒëŒ€ë°© ì´ë¦„</div>
      <div class="last-message" th:text="${room.lastMessage}">ë§ˆì§€ë§‰ ë©”ì‹œì§€</div>
      <div class="last-message-time" th:text="${#dates.format(room.lastMessageTime, 'MM/dd HH:mm')}">
        10/28 13:25
      </div>
      <div th:if="${room.unreadCount > 0}" class="unread-count" th:text="${room.unreadCount}">1</div>
    </div>
  </div>

  <!-- ==================== ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½ ==================== -->
  <div class="chat-window">
    <div class="chat-header">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</div>

    <div id="chatBox">
      <div class="chat-placeholder">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ë©´ ëŒ€í™” ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤ ğŸ’¬</div>
    </div>

    <!-- âœ… í•­ìƒ ë Œë”ë§, ì„ íƒ ì „ì—” ë¹„í™œì„±í™” -->
	<form id="chatForm">
	  <div class="chat-input-wrapper">
	    <label for="imageInput" class="image-upload-icon" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ">
	      <!-- ğŸ“· SVG ì¹´ë©”ë¼ ì•„ì´ì½˜ -->
	      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#4DB2FF" viewBox="0 0 16 16">
	        <path d="M10.5 2a.5.5 0 0 1 .416.223l.823 1.234A.5.5 0 0 0 12.1 4h2.4A1.5 1.5 0 0 1 16 5.5v8A1.5 1.5 0 0 1 14.5 15h-13A1.5 1.5 0 0 1 0 13.5v-8A1.5 1.5 0 0 1 1.5 4h2.4a.5.5 0 0 0 .361-.543l.823-1.234A.5.5 0 0 1 5.5 2zM8 6a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
	      </svg>
	    </label>
	
	    <textarea id="messageInput" name="content" placeholder="ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”..." disabled></textarea>
	
	    <button type="submit" disabled title="ì „ì†¡">
	      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 16 16">
	        <path d="M15.854.146a.5.5 0 0 1 .11.54l-6 14a.5.5 0 0 1-.924-.09L8 10.5l-6.5-1.04a.5.5 0 0 1-.09-.924l14-6a.5.5 0 0 1 .444 0z"/>
	      </svg>
	    </button>
	  </div>
	
	  <!-- âœ… ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
	  <div id="previewContainer" style="display:none;">
	    <img id="previewImage" alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
	    <span id="removePreview" onclick="removeImagePreview()">Ã—</span>
	  </div>
	
	  <input type="file" id="imageInput" name="img" accept="image/*" hidden disabled>
	</form>
  </div>
</div>

<!-- ==================== JS ==================== -->
<script th:inline="javascript">
const myNickname = '[[${myNickname}]]';
const myEmail = '[[${myEmail}]]';
const roomId = /*[[${roomId}]]*/ null;
let chatStompClient = null;

const messageInput = document.getElementById('messageInput');
const chatForm = document.getElementById('chatForm');
const imageInput = document.getElementById("imageInput");
const previewContainer = document.getElementById("previewContainer");
const previewImage = document.getElementById("previewImage");
const removePreview = document.getElementById("removePreview");

// ì„ íƒëœ ì±„íŒ…ë°© ì •ë³´ (ì „ì—­ ì €ì¥)
window.currentRoomId = null;
window.otherEmail = null;

connectRoom(myEmail);

//í˜ì´ì§€ ë¡œë”© ì‹œ ì„ íƒëœ ì±„íŒ…ë°©ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ë°”ë¡œ ì¶œë ¥
window.addEventListener('DOMContentLoaded', () => {
  if(roomId) {
	  const firstRoom = document.querySelector(`.chat-room[data-room-id='${roomId}']`);
	  
	  if (firstRoom) {
	    openChatRoom(firstRoom);
	  }
  }
  
});

messageInput.addEventListener('keydown', function(event) {
	if (event.key === 'Enter' && !event.shiftKey) {
		event.preventDefault();  //ì¤„ë°”ê¿ˆ ë°©ì§€
		chatForm.dispatchEvent(new Event('submit'));  //ë©”ì‹œì§€ ì „ì†¡
	}
});

/* ì„ íƒëœ ì±„íŒ…ë°© ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° */
async function openChatRoom(element) {
  const roomId = element.getAttribute("data-room-id");
  const roomName = element.getAttribute("data-room-name");

  document.querySelector(".chat-header").textContent = roomName;
  
  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML = "<p style='color:#aaa;text-align:center;'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

  try {
    const res = await fetch(`/chat/rooms/${roomId}`);
    if (!res.ok) throw new Error("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨");
    const data = await res.json();

    // âœ… ì „ì—­ ë³€ìˆ˜ ì €ì¥ (ì´ê²Œ í•µì‹¬!)
    window.currentRoomId = data.roomId;
    window.myEmail = data.myEmail;
    window.otherEmail = data.otherEmail;
    window.myNickname = data.myNickname;
    window.otherNickname = data.otherNickname;
    window.otherProfileImg = data.otherProfileImg;
    
    chatBox.innerHTML = "";
	data.messages.forEach(msg => {
	  const div = document.createElement("div");
	  div.className = (msg.senderEmail === data.myEmail)
	    ? "message message-out"
	    : "message message-in";
	
	  div.innerHTML = `<div class="meta ${msg.senderEmail === data.myEmail ? 'meta-right' : 'meta-left'}">`;
	  if (msg.senderEmail !== data.myEmail) {
		  div.innerHTML += `
		  	  <img class="otherProfileImg" 
			  src="${otherProfileImg}" alt="í”„ë¡œí•„" 
	  	      onerror="this.src='/img/userProfile/default.png'"
	  		  style="width: 30px; height: 30px; 
		  	  border-radius: 50%; object-fit: cover; 
		  	  margin-right:5px;">`;
	  }

	  div.innerHTML += `
	      <span class="nickname">${msg.senderNickname}</span>
	      <span class="time">${new Date(msg.sendedAt).toLocaleTimeString('ko-KR', {
	        hour:'2-digit', minute:'2-digit', hour12:true
	      })}</span>
	    </div>
	    <div class="bubble">
	      ${msg.content.replace(/\n/g, "<br>")}
	      ${msg.img && msg.img !== '-' ? `<br><img src="${msg.img}" width="200">` : ""}
	    </div>`;
	  chatBox.appendChild(div);
	});
    chatBox.scrollTop = chatBox.scrollHeight;

    // âœ… ì…ë ¥ì°½ í™œì„±í™”
    messageInput.disabled = false;
    imageInput.disabled = false;
    document.querySelector("#chatForm button").disabled = false;

    // âœ… í˜„ì¬ ë°© ì •ë³´ ì €ì¥
    window.currentRoomId = data.roomId;
    window.otherEmail = data.otherEmail;

    // âœ… WebSocket ì—°ê²°
    //connectRoom(data.roomId, data.myEmail);

	// âœ… ë§ˆì§€ë§‰ ë©”ì‹œì§€ ê¸°ì¤€ìœ¼ë¡œ ì½ìŒ ìƒíƒœ ê°±ì‹  ìš”ì²­
	if (data.messages.length > 0) {
	  const lastMsgId = data.messages[data.messages.length - 1].msgId;
	  fetch(`/chat/updateLastRead?roomId=${data.roomId}&msgId=${lastMsgId}`, {
	    method: "POST"
	  }).then(res => {
	    if (res.ok) {
	      // âœ… ì™¼ìª½ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ë°©ì˜ ì•Œë¦¼(ë¹¨ê°„ ìˆ«ì) ì œê±°
	      const roomItem = document.querySelector(`.chat-room[data-room-id="${data.roomId}"] .unread-count`);
	      if (roomItem) {
	        roomItem.style.display = "none";
	      }
	      console.log("ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
	      console.log("lastRead: " + lastMsgId);
	    }
	  }).catch(err => console.error("ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", err));
	}
		
	
  } catch (err) {
    chatBox.innerHTML = "<p style='color:red;text-align:center;'>ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
    console.error(err);
  }
}

/** âœ… WebSocket ì—°ê²° */  //roomId, 
function connectRoom(myEmail) {
  //if (chatStompClient) chatStompClient.disconnect(() => console.log("ì´ì „ ë°© ì—°ê²° í•´ì œ"));
  const socket = new SockJS('/ws-chat');
  chatStompClient = Stomp.over(socket);

  chatStompClient.connect({}, () => {
    console.log('Connected to chat: ');

    // âœ… ë°›ì€ myEmail ê·¸ëŒ€ë¡œ ì „ë‹¬
    /* chatStompClient.subscribe(`/topic/chat/${roomId}`, (output) => {
      const msg = JSON.parse(output.body);
      showRealtimeMessage(msg, myEmail);
    }); */
    
    document.querySelectorAll('.chat-room').forEach(room => {
        const roomId = room.dataset.roomId;
        chatStompClient.subscribe(`/topic/chat/${roomId}`, function(message) {
            const msg = JSON.parse(message.body);
            if (window.currentRoomId) {
            	showRealtimeMessage(msg, myEmail);
            } else {
            	updateChatListPreview(msg, myEmail);
            }
        });
    });
  });
}

/** âœ… ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ (í†µì¼ ë²„ì „) */
function showRealtimeMessage(message, myEmail) {
  const chatBox = document.getElementById("chatBox");

  const div = document.createElement("div");
	const cleanSender = message.senderEmail.replaceAll('"', '').trim();
	const cleanMy = myEmail.replaceAll('"', '').trim();
	
	div.className = (cleanSender === cleanMy)
	  ? "message message-out"
	  : "message message-in";

  // ë™ì¼í•œ meta + bubble êµ¬ì¡° ì‚¬ìš©
  div.innerHTML = `
    <div class="meta ${message.senderEmail === myEmail ? 'meta-right' : 'meta-left'}">
      <span class="nickname">${message.senderNickname}</span>
      <span class="time">${new Date(message.sendedAt).toLocaleTimeString('ko-KR', {
        hour:'2-digit', minute:'2-digit', hour12:true
      })}</span>
    </div>
    <div class="bubble">
      ${message.content.replace(/\n/g, "<br>")}
      ${message.img && message.img !== '-' ? `<br><img src="${message.img}" width="200">` : ""}
    </div>
  `;

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  
  updateChatListPreview(message, myEmail);
}

/* ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹  */
function updateChatListPreview(message, myEmail) {
  const roomItem = document.querySelector(`.chat-room[data-room-id="${message.roomId}"]`);
  if (!roomItem) return;

  // ë©”ì‹œì§€ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ê¸´ ê²½ìš° ìë¥´ê¸°)
  let previewText = "";
  if (message.img && message.img !== '-') {
    previewText = "ì´ë¯¸ì§€";
  } else {
    previewText = message.content || "";
    if (previewText.length > 25) previewText = previewText.substring(0, 25) + "â€¦";
  }

  const lastMsgEl = roomItem.querySelector(".last-message");
  const lastTimeEl = roomItem.querySelector(".last-message-time");

  lastMsgEl.textContent = previewText;
  lastTimeEl.textContent = new Date(message.sendedAt).toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });

  // ë‹¤ë¥¸ ì‚¬ëŒì´ ë©”ì‹œì§€ ë³´ëƒˆê³ , 
  // ì§€ê¸ˆ ê·¸ ì±„íŒ…ë°©ì„ ë³´ê³  ìˆì§€ ì•Šìœ¼ë©´ 
  // â€œì½ì§€ ì•Šì€ ìˆ˜â€ +1
  if ((message.senderEmail !== myEmail)
		  && (window.currentRoomId != message.roomId)) {
    let unreadEl = roomItem.querySelector(".unread-count");
    if (!unreadEl) {
      unreadEl = document.createElement("div");
      unreadEl.className = "unread-count";
      //unreadEl.textContent = "1";
      roomItem.appendChild(unreadEl);
    } /* else {
      unreadEl.textContent = parseInt(unreadEl.textContent) + 1;
      unreadEl.style.display = "block";
    } */
    
    let count = parseInt(unreadEl.innerText || '0');
    count += 1;
    unreadEl.innerText = count;
  }
}

/** âœ… ë©”ì‹œì§€ ì „ì†¡ */
chatForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  /* const input = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput"); */
  let imageUrl = "-";

  if (imageInput.files.length > 0) {
    const formData = new FormData();
    formData.append("image", imageInput.files[0]);
    formData.append("roomId", window.currentRoomId);
    
    const res = await fetch("/chat/uploadImage", { method: "POST", body: formData });
    if (res.ok) {
      const result = await res.json();
      imageUrl = result.imgUrl;
    } else {
      alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
      return;
    }
  }

  const msg = messageInput.value.trim();
  if (!msg && imageUrl === "-") return;

  sendMessage(msg, imageUrl);
  messageInput.value = "";
  removeImagePreview();
});

/* ë©”ì‹œì§€ ì „ì†¡ */
function sendMessage(content, img="-") {
  if (chatStompClient && chatStompClient.connected) {
	  chatStompClient.send("/app/message/send", {}, JSON.stringify({
      roomId: window.currentRoomId,
      senderNickname: myNickname,
      senderEmail: myEmail,
      receiverEmail: window.otherEmail,
      content, img
    }));
  }
}

/** âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ */
imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      previewImage.src = e.target.result;
      previewContainer.style.display = "inline-block";
    };
    reader.readAsDataURL(file);
  }
});

/* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì œê±° */
function removeImagePreview() {
  imageInput.value = "";
  previewContainer.style.display = "none";
  previewImage.src = "";
}

function goBack() {
  // ë°©ë²• â‘ : ë¸Œë¼ìš°ì € ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
  history.back();

  // ğŸ”¹ ë˜ëŠ” íŠ¹ì • URLë¡œ ì´ë™í•˜ê³  ì‹¶ë‹¤ë©´:
  // window.location.href = "/home";
}
</script>
</body>
</html>