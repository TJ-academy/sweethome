<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì±„íŒ…</title>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<style>
body {
  font-family: 'Noto Sans KR', sans-serif;
  margin: 0;
  background-color: #e9eef6;
}
.container {
  display: flex;
  height: 100vh;
}

/* ===============================
   ì™¼ìª½: ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸
   =============================== */
.chat-list {
  width: 320px;
  background-color: #fff;
  border-right: 1px solid #ddd;
  overflow-y: auto;
}
.chat-list h2 {
  padding: 15px 20px;
  margin: 0;
  border-bottom: 1px solid #eee;
  font-size: 1.2rem;
}
.chat-room {
  border-bottom: 1px solid #eee;
  padding: 12px 15px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.chat-room:hover { background-color: #f5f5f5; }
.room-name { font-weight: bold; font-size: 1rem; }
.last-message { color: #555; font-size: 0.9rem; margin-top: 3px; }
.last-message-time { color: #999; font-size: 0.8rem; }
.unread-count {
  color: white; background-color: #ff3b30; border-radius: 50%;
  width: 20px; height: 20px; font-size: 0.8em;
  text-align: center; line-height: 20px; float: right;
  margin-top: -40px; margin-right: 10px; font-weight: bold;
}
.empty-message { padding: 20px; color: #888; text-align: center; }

/* ===============================
   ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½
   =============================== */
.chat-window {
  flex: 1;
  display: flex;
  flex-direction: column;
  background-color: #e9eef6;
}
.chat-header {
  padding: 15px;
  background-color: #fff;
  border-bottom: 1px solid #ddd;
  font-weight: bold;
}
#chatBox {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
}
.date-separator {
  font-weight: bold;
  text-align: center;
  margin: 10px 0;
  color: #666;
  font-size: 0.85rem;
}

/* ===============================
   ë©”ì‹œì§€ ê³µí†µ
   =============================== */
/* ê³µí†µ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ */
.message {
  display: flex;
  flex-direction: column;
  max-width: 70%;
  margin-bottom: 14px;
}

/* ë³´ë‚¸ ë©”ì‹œì§€ */
.message-out {
  align-self: flex-end;
  text-align: right;
}

/* ë°›ì€ ë©”ì‹œì§€ */
.message-in {
  align-self: flex-start;
  text-align: left;
}

/* ë‹‰ë„¤ì„ + ì‹œê°„ */
.meta {
  display: flex;
  align-items: center;
  font-size: 0.8rem;
  color: #888;
  margin-bottom: 4px;
}
.meta-left { justify-content: flex-start; }
.meta-right { justify-content: flex-end; }
.nickname {
  font-weight: 500;
}
.time {
  margin-left: 6px;
  font-size: 0.75rem;
  color: #aaa;
}

/* ë§í’ì„  ìì²´ */
.bubble {
  padding: 10px 14px;
  border-radius: 16px;
  line-height: 1.5;
  word-break: break-word;
  box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

/* ì˜¤ë¥¸ìª½(ë‚´ê°€ ë³´ë‚¸ ë§í’ì„ ) */
.message-out .bubble {
  background-color: #4DB2FF;
  color: #fff;
  border-radius: 16px 16px 2px 16px;
}

/* ì™¼ìª½(ìƒëŒ€ë°© ë§í’ì„ ) */
.message-in .bubble {
  background-color: #f1f1f1;
  color: #000;
  border-radius: 16px 16px 16px 2px;
}

/* ===============================
   ì…ë ¥ ì˜ì—­ (modern wide style)
   =============================== */
#chatForm {
  background-color: #e9eef6;
  padding: 14px 20px;
  border-top: 1px solid #d0d7de;
}

.chat-input-wrapper {
  display: flex;
  align-items: center;
  background-color: #fff;
  border: 2px solid transparent;
  border-radius: 24px;
  padding: 10px 14px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.chat-input-wrapper:focus-within {
  border-color: #4DB2FF;
  box-shadow: 0 0 0 3px rgba(77, 178, 255, 0.2);
}

/* ì¹´ë©”ë¼ ì•„ì´ì½˜ */
.image-upload-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin-right: 12px;
  transition: transform 0.2s ease;
}
.image-upload-icon:hover svg {
  transform: scale(1.1);
}

/* ì…ë ¥ì°½ */
#messageInput {
  flex: 1;
  resize: none;
  border: none;
  outline: none;
  font-size: 1rem;
  padding: 10px 0;
  background-color: transparent;
  font-family: 'Noto Sans KR', sans-serif;
  color: #222;
  min-height: 44px; /* âœ… ë†’ì´ ëŠ˜ë¦¼ */
  line-height: 1.5;
}
#messageInput::placeholder {
  color: #aaa;
}

/* ì „ì†¡ ë²„íŠ¼ (ë‘¥ê·¼ ì•„ì´ì½˜) */
#chatForm button {
  width: 42px;
  height: 42px;
  border: none;
  border-radius: 50%;
  background-color: #4DB2FF;
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s ease, transform 0.2s ease;
}
#chatForm button:hover {
  background-color: #3ca0e6;
  transform: scale(1.05);
}
#chatForm button:disabled {
  background-color: #ccc;
  cursor: default;
}

/* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
#previewContainer {
  position: relative;
  display: inline-block;
  margin-top: 10px;
  margin-left: 6px;
}
#previewImage {
  max-width: 140px;
  max-height: 140px;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  object-fit: cover;
}
#removePreview {
  position: absolute;
  top: -6px;
  right: -6px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  line-height: 16px;
  text-align: center;
  cursor: pointer;
}
#removePreview:hover {
  background: rgba(0,0,0,0.8);
}

/* ===============================
   ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ë‚´ ì±„íŒ…ë°© í—¤ë”)
   =============================== */
.chat-list-header {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #eee;
  padding: 12px 18px;
  background-color: #fff;
}

.chat-list-header h2 {
  margin: 0;
  margin-left: 6px;
  font-size: 1.2rem;
  font-weight: 600;
}

.back-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s ease;
}
.back-btn:hover {
  transform: translateX(-2px);
}

</style>

</head>

<body>
<div class="container">

  <!-- ==================== ì™¼ìª½: ì±„íŒ…ë°© ëª©ë¡ ==================== -->
  <div class="chat-list">
    <div class="chat-list-header">
	  <button class="back-btn" onclick="goBack()">
	    <!-- ì™¼ìª½ í™”ì‚´í‘œ ì•„ì´ì½˜ (Bootstrap SVG) -->
	    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#4DB2FF" viewBox="0 0 16 16">
	      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
	    </svg>
	  </button>
	  <h2>ë‚´ ì±„íŒ…ë°©</h2>
	</div>

    <div th:if="${roomsList == null or #lists.isEmpty(roomsList)}" class="empty-message">
      ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <div th:each="room : ${roomsList}" class="chat-room"
         th:attr="data-room-id=${room.roomId}, data-room-name=${room.roomName}"
         onclick="openChatRoom(this)">
      <div class="room-name" th:text="${room.roomName}">ìƒëŒ€ë°© ì´ë¦„</div>
      <div class="last-message" th:text="${room.lastMessage}">ë§ˆì§€ë§‰ ë©”ì‹œì§€</div>
      <div class="last-message-time" th:text="${#dates.format(room.lastMessageTime, 'MM/dd HH:mm')}">
        10/28 13:25
      </div>
      <div th:if="${room.unreadCount > 0}" class="unread-count" th:text="${room.unreadCount}">1</div>
    </div>
  </div>

  <!-- ==================== ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½ ==================== -->
  <div class="chat-window">
    <div class="chat-header">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</div>

    <div id="chatBox">
      <div class="chat-placeholder">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ë©´ ëŒ€í™” ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤ ğŸ’¬</div>
    </div>

    <!-- âœ… í•­ìƒ ë Œë”ë§, ì„ íƒ ì „ì—” ë¹„í™œì„±í™” -->
	<form id="chatForm">
	  <div class="chat-input-wrapper">
	    <label for="imageInput" class="image-upload-icon" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ">
	      <!-- ğŸ“· SVG ì¹´ë©”ë¼ ì•„ì´ì½˜ -->
	      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#4DB2FF" viewBox="0 0 16 16">
	        <path d="M10.5 2a.5.5 0 0 1 .416.223l.823 1.234A.5.5 0 0 0 12.1 4h2.4A1.5 1.5 0 0 1 16 5.5v8A1.5 1.5 0 0 1 14.5 15h-13A1.5 1.5 0 0 1 0 13.5v-8A1.5 1.5 0 0 1 1.5 4h2.4a.5.5 0 0 0 .361-.543l.823-1.234A.5.5 0 0 1 5.5 2zM8 6a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
	      </svg>
	    </label>
	
	    <textarea id="messageInput" name="content" placeholder="ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”..." disabled></textarea>
	
	    <button type="submit" disabled title="ì „ì†¡">
	      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 16 16">
	        <path d="M15.854.146a.5.5 0 0 1 .11.54l-6 14a.5.5 0 0 1-.924-.09L8 10.5l-6.5-1.04a.5.5 0 0 1-.09-.924l14-6a.5.5 0 0 1 .444 0z"/>
	      </svg>
	    </button>
	  </div>
	
	  <!-- âœ… ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
	  <div id="previewContainer" style="display:none;">
	    <img id="previewImage" alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
	    <span id="removePreview">Ã—</span>
	  </div>
	
	  <input type="file" id="imageInput" name="img" accept="image/*" hidden disabled>
	</form>
  </div>
</div>

<!-- ==================== JS ==================== -->
<script th:inline="javascript">
const myNickname = '[[${myNickname}]]';
const myEmail = '[[${myEmail}]]';
let stompClient = null;

// ì„ íƒëœ ì±„íŒ…ë°© ì •ë³´ (ì „ì—­ ì €ì¥)
window.currentRoomId = null;
window.otherEmail = null;

/** âœ… ì„ íƒëœ ì±„íŒ…ë°© ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° */
async function openChatRoom(element) {
  const roomId = element.getAttribute("data-room-id");
  const roomName = element.getAttribute("data-room-name");

  document.querySelector(".chat-header").textContent = roomName;
  
  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML = "<p style='color:#aaa;text-align:center;'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

  try {
    const res = await fetch(`/chat/messages/${roomId}`);
    if (!res.ok) throw new Error("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨");
    const data = await res.json();

    // âœ… ì „ì—­ ë³€ìˆ˜ ì €ì¥ (ì´ê²Œ í•µì‹¬!)
    window.currentRoomId = data.roomId;
    window.myEmail = data.myEmail;
    window.otherEmail = data.otherEmail;
    window.myNickname = data.myNickname;
    window.otherNickname = data.otherNickname;
    
    chatBox.innerHTML = "";
	data.messages.forEach(msg => {
	  const div = document.createElement("div");
	  div.className = (msg.senderEmail === data.myEmail)
	    ? "message message-out"
	    : "message message-in";
	
	  div.innerHTML = `
	    <div class="meta ${msg.senderEmail === data.myEmail ? 'meta-right' : 'meta-left'}">
	      <span class="nickname">${msg.senderNickname}</span>
	      <span class="time">${new Date(msg.sendedAt).toLocaleTimeString('ko-KR', {
	        hour:'2-digit', minute:'2-digit', hour12:true
	      })}</span>
	    </div>
	    <div class="bubble">
	      ${msg.content.replace(/\n/g, "<br>")}
	      ${msg.img && msg.img !== '-' ? `<br><img src="${msg.img}" width="200">` : ""}
	    </div>`;
	  chatBox.appendChild(div);
	});
    chatBox.scrollTop = chatBox.scrollHeight;

    // âœ… ì…ë ¥ì°½ í™œì„±í™”
    document.getElementById("messageInput").disabled = false;
    document.getElementById("imageInput").disabled = false;
    document.querySelector("#chatForm button").disabled = false;

    // âœ… í˜„ì¬ ë°© ì •ë³´ ì €ì¥
    window.currentRoomId = data.roomId;
    window.otherEmail = data.otherEmail;

    // âœ… WebSocket ì—°ê²°
    connectRoom(data.roomId, data.myEmail);

	// âœ… ë§ˆì§€ë§‰ ë©”ì‹œì§€ ê¸°ì¤€ìœ¼ë¡œ ì½ìŒ ìƒíƒœ ê°±ì‹  ìš”ì²­
	if (data.messages.length > 0) {
	  const lastMsgId = data.messages[data.messages.length - 1].msgId;
	  fetch(`/chat/updateLastRead?roomId=${data.roomId}&msgId=${lastMsgId}`, {
	    method: "POST"
	  }).then(res => {
	    if (res.ok) {
	      // âœ… ì™¼ìª½ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ë°©ì˜ ì•Œë¦¼(ë¹¨ê°„ ìˆ«ì) ì œê±°
	      const roomItem = document.querySelector(`.chat-room[data-room-id="${data.roomId}"] .unread-count`);
	      if (roomItem) {
	        roomItem.style.display = "none";
	      }
	      console.log("ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
	    }
	  }).catch(err => console.error("ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", err));
	}
		
	
  } catch (err) {
    chatBox.innerHTML = "<p style='color:red;text-align:center;'>ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
    console.error(err);
  }
}

/** âœ… WebSocket ì—°ê²° */
function connectRoom(roomId, myEmail) {
  if (stompClient) stompClient.disconnect(() => console.log("ì´ì „ ë°© ì—°ê²° í•´ì œ"));
  const socket = new SockJS('/ws');
  stompClient = Stomp.over(socket);

  stompClient.connect({}, () => {
    console.log('Connected to room: ' + roomId);

    // âœ… ë°›ì€ myEmail ê·¸ëŒ€ë¡œ ì „ë‹¬
    stompClient.subscribe(`/topic/chat/${roomId}`, (output) => {
      const msg = JSON.parse(output.body);
      showRealtimeMessage(msg, myEmail);
    });
  });
}

/** âœ… ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ (í†µì¼ ë²„ì „) */
function showRealtimeMessage(message, myEmail) {
  const chatBox = document.getElementById("chatBox");

  const div = document.createElement("div");
	const cleanSender = message.senderEmail.replaceAll('"', '').trim();
	const cleanMy = myEmail.replaceAll('"', '').trim();
	
	div.className = (cleanSender === cleanMy)
	  ? "message message-out"
	  : "message message-in";

  // ë™ì¼í•œ meta + bubble êµ¬ì¡° ì‚¬ìš©
  div.innerHTML = `
    <div class="meta ${message.senderEmail === myEmail ? 'meta-right' : 'meta-left'}">
      <span class="nickname">${message.senderNickname}</span>
      <span class="time">${new Date(message.sendedAt).toLocaleTimeString('ko-KR', {
        hour:'2-digit', minute:'2-digit', hour12:true
      })}</span>
    </div>
    <div class="bubble">
      ${message.content.replace(/\n/g, "<br>")}
      ${message.img && message.img !== '-' ? `<br><img src="${message.img}" width="200">` : ""}
    </div>
  `;

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}


/** âœ… ë©”ì‹œì§€ ì „ì†¡ */
document.getElementById("chatForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput");
  let imageUrl = "-";

  if (imageInput.files.length > 0) {
    const formData = new FormData();
    formData.append("image", imageInput.files[0]);
    formData.append("roomId", window.currentRoomId);
    const res = await fetch("/chat/uploadImage", { method: "POST", body: formData });
    if (res.ok) {
      const result = await res.json();
      imageUrl = result.imgUrl;
    } else {
      alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
      return;
    }
  }

  const msg = input.value.trim();
  if (!msg && imageUrl === "-") return;

  sendMessage(msg, imageUrl);
  input.value = "";
  imageInput.value = "";
});

/** âœ… WebSocket ë©”ì‹œì§€ ì „ì†¡ */
function sendMessage(content, img="-") {
  if (stompClient && stompClient.connected) {
    stompClient.send("/app/message/send", {}, JSON.stringify({
      roomId: window.currentRoomId,
      senderNickname: myNickname,
      senderEmail: myEmail,
      receiverEmail: window.otherEmail,
      content, img
    }));
  }
}

/** âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ */
const imageInput = document.getElementById("imageInput");
const previewContainer = document.getElementById("previewContainer");
const previewImage = document.getElementById("previewImage");
const removePreview = document.getElementById("removePreview");

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      previewImage.src = e.target.result;
      previewContainer.style.display = "inline-block";
    };
    reader.readAsDataURL(file);
  }
});

/** âœ… ë¯¸ë¦¬ë³´ê¸° ì œê±° ë²„íŠ¼ */
removePreview.addEventListener("click", () => {
  imageInput.value = "";
  previewContainer.style.display = "none";
  previewImage.src = "";
});

function goBack() {
  // ë°©ë²• â‘ : ë¸Œë¼ìš°ì € ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
  history.back();

  // ğŸ”¹ ë˜ëŠ” íŠ¹ì • URLë¡œ ì´ë™í•˜ê³  ì‹¶ë‹¤ë©´:
  // window.location.href = "/home";
}
</script>
</body>
</html>
