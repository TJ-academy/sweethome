<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>투데이 일정 | 마이페이지</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
  <link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
  <link rel="stylesheet" th:href="@{/css/host/today.css}">
<style>
/* 필터 영역 분리 문제 해결 */
.hidden {
    display: none !important;
}

/* 필터 칩 래퍼들에도 필요 시 추가 */
.status-filter-wrap.hidden,
.period-filter-wrap.hidden,
.request-filter-wrap.hidden {
    display: none !important;
}
</style>
</head>
<body>
<div th:insert="~{fragments/header :: menuBar}"></div>

<div class="mypage-layout-wrap container-fluid">
  <div class="row">
    <div class="mypage-sidebar-col">
      <div th:insert="~{fragments/sidebarHost :: hostSideBar}"></div>
    </div>

    <div class="mypage-content-col">
      <div class="mypage-content-area">

        <div class="host-tabs">
          <button class="tab-btn" data-tab="today" th:classappend="${currentTab == 'today' ? 'active' : ''}">오늘</button>
          <button class="tab-btn" data-tab="upcoming" th:classappend="${currentTab == 'upcoming' ? 'active' : ''}">예정</button>
          <button class="tab-btn" data-tab="requests" th:classappend="${currentTab == 'requests' ? 'active' : ''}">예약</button>
        </div>

        <section class="host-board">
          <div class="board-header">
            <div class="board-date">오늘 날짜: <span th:text="${todayDate}">2025-10-24</span></div>
          </div>

		<div class="chip-wrap home-filter-wrap">
		  <button class="chip active" data-home-idx="all">전체 숙소</button>
		
		  <button class="chip"
		          th:each="home : ${myHomes}"
		          th:attr="data-home-idx=${home.idx}"
		          th:style="'--bg:url(' + ${home.thumbnail} + ');'">
		      <span th:text="${home.title}"></span>
		  </button>
		</div>

          <div class="chip-wrap status-filter-wrap" id="filter-today" th:classappend="${currentTab != 'today' ? 'hidden' : ''}">
              <button class="chip status-chip active" data-status="all">전체 오늘 일정</button>
              <button class="chip status-chip" data-status="checkin">오늘 체크인 예정</button>
              <button class="chip status-chip" data-status="inuse">숙박 중</button>
              <button class="chip status-chip" data-status="checkout">오늘 체크아웃 예정</button>
          </div>

          <div class="chip-wrap period-filter-wrap hidden" id="filter-upcoming" th:classappend="${currentTab == 'upcoming' ? '' : 'hidden'}">
          	  <button class="chip period-chip" data-period="3">3일 이내</button>
              <button class="chip period-chip" data-period="7">7일 이내</button>
              <button class="chip period-chip active" data-period="30">30일 이내</button>
          </div>

          <div class="chip-wrap request-filter-wrap hidden" id="filter-requests" th:classappend="${currentTab == 'requests' ? '' : 'hidden'}">
              <button class="chip request-chip active" data-request-type="all">전체 요청</button>
              <button class="chip request-chip" data-request-type="requested">예약 요청</button>
              <button class="chip request-chip" data-request-type="cancel">취소 요청</button>
          </div>

          <div class="board-table">
            <table class="table booking-table">
              <thead>
                <tr>
                  <th>숙소</th>
                  <th>게스트</th>
                  <th>체크인/체크아웃</th>
                  <th>상태</th>
                  <th>관리</th>
                </tr>
              </thead>

              <tbody id="reservation-list">
    
                <th:block th:each="r : ${todayReservations}">
                    <tr th:data-tab="today"
                        th:data-home-idx="${r.reservedHome.idx}"
                        th:attr="data-status-category=${#strings.equals(#temporals.format(r.startDate, 'yyyy-MM-dd'), todayDate) ? 'checkin' :
                        (#strings.equals(#temporals.format(r.endDate, 'yyyy-MM-dd'), todayDate) ? 'checkout' : 'inuse')}"
                        
                        th:classappend="${currentTab == 'today' ? '' : 'hidden'}"
                        >
                        <th:block th:insert="~{host/today :: reservationRowContent(r=${r})}"></th:block>
                    </tr>
                </th:block>

                <th:block th:each="r : ${upcomingReservations}">
                    <tr th:data-tab="upcoming"
                        th:data-home-idx="${r.reservedHome.idx}"
                        th:attr="data-start-date=${#temporals.format(r.startDate, 'yyyyMMdd')}"
                        th:classappend="${currentTab == 'upcoming' ? '' : 'hidden'}"
                        >
                        <th:block th:insert="~{host/today :: reservationRowContent(r=${r})}"></th:block>
                    </tr>
                </th:block>

                <th:block th:each="r : ${requestReservations}">
                    <tr th:data-tab="requests"
                        th:data-home-idx="${r.reservedHome.idx}"
                        th:attr="data-request-type=${r.reservationStatus.name() == 'REQUESTED' ? 'requested' : 'cancel'}"
                        th:classappend="${currentTab == 'requests' ? '' : 'hidden'}"
                        >
                        <th:block th:insert="~{host/today :: reservationRowContent(r=${r})}"></th:block>
                    </tr>
                </th:block>

                <tr id="empty-message-row" class="hidden">
                  <td colspan="5" class="text-center p-4 text-muted">선택된 조건에 맞는 예약이 없습니다.</td>
                </tr>

              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<div th:fragment="reservationRowContent(r)" style="display: none;">
    <td>
        <a th:href="@{|/host/reservation/detail/${r != null ? r.reservationIdx : ''}|}">
            <div class="home-cell">
                <div class="home-title" th:text="${r != null ? r.reservedHome.title : 'Unknown Home'}"></div>
                <div class="home-meta" th:text="${r != null ? r.reservedHome.location : 'Unknown Location'}"></div>
            </div>
        </a>
    </td>
    
    <td>
        <a th:href="@{|/host/reservation/detail/${r != null ? r.reservationIdx : ''}|}" 
           th:text="${r != null ? r.booker.nickname : 'Unknown Guest'}"></a>
    </td>
    
    <td>
        <span th:text="${r != null ? #temporals.format(r.startDate, 'MM/dd') : 'MM/DD'}"></span>
        ~
        <span th:text="${r != null ? #temporals.format(r.endDate, 'MM/dd') : 'MM/DD'}"></span>
    </td>
    
    <td>
      <span th:if="${r != null && r.reservationStatus.name() == 'CONFIRMED'}" class="badge-soft pink">예약 확정</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'IN_USE'}" class="badge-soft gray">숙박 중</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'COMPLETED'}" class="badge-soft success">이용 완료</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'REQUESTED'}" class="badge-soft warning">요청 대기</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'CANCEL_REQUESTED'}" class="badge-soft warning">취소 요청</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'CANCELLED'}" class="badge-soft gray">취소 완료</span>
      <span th:if="${r != null && r.reservationStatus.name() == 'REJECTED'}" class="badge-soft gray">예약 거절</span>
    </td>
    
    <td>
        <a th:href="@{|/host/reservation/detail/${r != null ? r.reservationIdx : ''}|}" class="btn btn-outline-primary btn-sm">상세</a>
    </td>
</div>
<script th:inline="javascript">
    /* <![CDATA[ */
    const TODAY_DATE_YMD = '[[${#temporals.format(todayDate, "yyyyMMdd")}]]';
    const rows = document.querySelectorAll('#reservation-list tr[data-tab]');
    const emptyMessageRow = document.getElementById('empty-message-row');
    /*
    let activeTab = '[[${currentTab}]]'; // 서버에서 넘겨받은 초기 탭을 사용
    let activeHomeIdx = 'all';
	*/
	//나래수정 시작
	let activeTab = 'today'; 
    
    let activeHomeIdx = 'all';
    
    // 💡 추가 1: 초기 로드 시 today 탭 버튼과 필터 영역을 강제로 활성화/표시
    document.querySelectorAll('.host-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.host-tabs .tab-btn[data-tab="today"]').classList.add('active');
    
    document.getElementById('filter-today').classList.remove('hidden');
    document.getElementById('filter-upcoming').classList.add('hidden');
    document.getElementById('filter-requests').classList.add('hidden');
    
    // 숙소 필터 초기화 확인 (선택 사항이지만 안전을 위해)
    document.querySelectorAll('.home-filter-wrap .chip').forEach(chip => chip.classList.remove('active'));
    document.querySelector('.home-filter-wrap .chip[data-home-idx="all"]').classList.add('active');
    
    // 내부 필터 '전체 오늘 일정' 활성화 확인
    document.querySelectorAll('#filter-today .chip').forEach(chip => chip.classList.remove('active'));
    document.querySelector('#filter-today .chip:first-child').classList.add('active');
    //나래수정끝
    
    // 1. 메인 탭 전환 및 필터 초기화
    document.querySelectorAll('.host-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.host-tabs .tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            activeTab = e.target.getAttribute('data-tab');

            // 💡 탭별 필터 영역 표시/숨김 강화
            document.getElementById('filter-today').classList.add('hidden');
            document.getElementById('filter-upcoming').classList.add('hidden');
            document.getElementById('filter-requests').classList.add('hidden');
            document.getElementById('filter-' + activeTab).classList.remove('hidden');
            
            // 숙소 필터를 '전체'로 초기화
            document.querySelectorAll('.home-filter-wrap .chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('.home-filter-wrap .chip[data-home-idx="all"]').classList.add('active');
            activeHomeIdx = 'all';

            // 탭별 내부 필터 '전체' 또는 기본값으로 초기화
            document.querySelectorAll('#filter-' + activeTab + ' .chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('#filter-' + activeTab + ' .chip:first-child').classList.add('active');

            updateReservationList();
        });
    });

    // 2. 통합 필터링 로직 함수
    function updateReservationList() {
        let visibleCount = 0;
        
        //초기상태 필터적용을 위해 모든 행 초기화
        rows.forEach(row => row.classList.remove('hidden'));
        
        // 현재 탭의 내부 필터 값 가져오기
        const activeInnerFilter = document.querySelector('#filter-' + activeTab + ' .chip.active');
        const filterValue = activeInnerFilter ? (activeTab === 'upcoming' ? activeInnerFilter.getAttribute('data-period') : activeInnerFilter.getAttribute('data-status') || activeInnerFilter.getAttribute('data-request-type')) : 'all';
        
        // 오늘 날짜 계산 (예정 탭 필터링 기준)
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        rows.forEach(row => {
            const rowTab = row.getAttribute('data-tab');
            const rowHomeIdx = row.getAttribute('data-home-idx');
            
            let isVisible = true;

            // 💡 1) 메인 탭 필터링: 활성 탭과 다르면 무조건 숨기고 다음 행으로
            if (rowTab !== activeTab) {
                row.classList.add('hidden'); 
                return; 
            }

            // 활성 탭에 속하는 경우에만 초기 표시 (이후 필터링 로직을 따름)
            row.classList.remove('hidden');

            // 2) 숙소 필터링
            if (activeHomeIdx !== 'all' && rowHomeIdx !== activeHomeIdx) {
                isVisible = false;
            }

            // 3) 내부 필터링 (탭별 로직)
            if (isVisible) {
                if (activeTab === 'today') {
                    const rowStatusCategory = row.getAttribute('data-status-category');
                    if (filterValue !== 'all' && rowStatusCategory !== filterValue) {
                        isVisible = false;
                    }
                } else if (activeTab === 'upcoming') {
                    const rowStartDateStr = row.getAttribute('data-start-date'); // YYYYMMDD
                    const periodDays = parseInt(filterValue, 10);
                    
                    if (periodDays !== 30) {
                        const rowStartDate = new Date(rowStartDateStr.substring(0, 4), rowStartDateStr.substring(4, 6) - 1, rowStartDateStr.substring(6, 8));
                        
                        const diffTime = rowStartDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        // 체크인 예정일이 오늘 날짜보다 크고 (diffDays > 0) 필터 기간 이내인 경우만 표시
                        if (diffDays > periodDays || diffDays <= 0) { 
                            isVisible = false;
                        }
                    }
                } else if (activeTab === 'requests') {
                    const rowRequestType = row.getAttribute('data-request-type');
                    if (filterValue !== 'all' && rowRequestType !== filterValue) {
                        isVisible = false;
                    }
                }
            }
            
            // 최종 표시/숨김
            row.classList.toggle('hidden', !isVisible);
            if (isVisible) {
                visibleCount++;
            }
        });
        
        // 예약 없음 메시지 처리
        emptyMessageRow.classList.toggle('hidden', visibleCount > 0);
    }
    
	// 3. 숙소 필터 이벤트 리스너 (공통)
	document.querySelectorAll('.home-filter-wrap .chip').forEach(chip => {
	  chip.addEventListener('click', (e) => {
	    const targetChip = e.target.closest('.chip'); // ✅ 내부 span 클릭 방지
	    if (!targetChip) return;
	
	    document.querySelectorAll('.home-filter-wrap .chip').forEach(c => c.classList.remove('active'));
	    targetChip.classList.add('active');
	
	    activeHomeIdx = targetChip.getAttribute('data-home-idx');
	    updateReservationList();
	  });
	});

    // 4. 내부 필터 이벤트 리스너 (탭별)
    document.querySelectorAll('.status-chip, .period-chip, .request-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            // 같은 칩 그룹의 active 상태를 관리
            e.target.parentElement.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            updateReservationList();
        });
    });
    
    // 페이지 로드 시 초기 탭 상태에 맞춰 목록 표시
    updateReservationList();

    /* ]]> */
</script>
</body>
</html>