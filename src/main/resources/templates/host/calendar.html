<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>일정 관리 달력 | 마이페이지</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

  <!-- Optional (thymeleaf app styles) -->
  <link rel="stylesheet" th:href="@{/css/fragments/fragments.css}">
  <link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">

  <style>
    .main-container { padding: 0; }
    .calendar-card { border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .schedule-detail { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .schedule-item { border-left: 5px solid; padding-left: 15px; margin-bottom: 15px; }

    .calendar-grid { padding: 20px; }
    .month-name { font-size: 24px; font-weight: 300; }

    /* 날짜칸 점(체크인/체크아웃 마커) */
    .fc-dotwrap { display:flex; gap:6px; align-items:center; margin-left:6px; }
    .fc-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
    .fc-dot.checkin  { background:#007bff; }  /* 파랑: 체크인 */
    .fc-dot.checkout { background:#dc3545; }  /* 빨강: 체크아웃 */
  </style>
</head>
<body>
  <div th:insert="~{fragments/header :: menuBar}"></div>

  <div class="mypage-layout-wrap container-fluid">
    <div class="row">
      <div class="mypage-sidebar-col">
        <div th:insert="~{fragments/sidebarHost :: hostSideBar}"></div>
      </div>

      <div class="mypage-content-col">
        <div class="mypage-content-area">
          <div class="container-fluid main-container">
            <div class="row">
              <!-- 캘린더 -->
              <div class="col-lg-8">
                <div class="p-4 bg-white calendar-card">
                  <div id="calendar" class="calendar-grid"></div>
                </div>
              </div>

              <!-- 우측 일정/메모 패널 -->
              <div class="col-lg-4 mt-4 mt-lg-0">
                <div class="schedule-detail">
                  <p class="text-muted">일정을 불러오고 있습니다.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>  
    </div>
  </div>

  <!-- 메모 모달 -->
  <div class="modal fade" id="memoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">메모 편집</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="small text-muted mb-2" id="memoModalInfo"></div>
          <textarea id="memoTextarea" class="form-control" rows="6" placeholder="메모를 입력하세요..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="btnMemoDelete" class="btn btn-outline-danger">메모 삭제</button>
          <button type="button" id="btnMemoSave" class="btn btn-primary">저장</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
          crossorigin="anonymous"></script>

  <script>
    // ---------- 우측 패널: 일정 로드 ----------
    function loadSchedules(dateStr) {
      const box = document.querySelector('.schedule-detail');
      const d = new Date(dateStr + 'T00:00:00');
      const day = d.getDate();
      box.innerHTML = `<h5><span class="text-primary">${day}</span>일 일정</h5><hr><p class="text-muted">일정 로딩 중...</p>`;

      fetch('/api/schedules/day?date=' + dateStr)
        .then(res => { if (!res.ok) throw new Error(res.status); return res.json(); })
        .then(list => {
          let html = `<h5><span class="text-primary">${day}</span>일 일정</h5><hr>`;
          if (!list || list.length === 0) {
            html += `<p class="text-muted">일정이 없습니다.</p>`;
          } else {
            list.forEach(item => {
              // 체크인 카드
              if (item.checkInTime) {
                const memo = (item.memoForCheckIn || '').replace(/"/g, '&quot;');
                html += `
                  <div class="schedule-item"
                       style="border-left-color:#007bff;"
                       data-reservation-id="${item.reservationId}"
                       data-home-title="${item.homeTitle}"
                       data-guest="${item.guestNickname}"
                       data-memo-type="CHECKIN"
                       data-memo="${memo}">
                    <p class="mb-1 d-flex align-items-center justify-content-between">
                      <span>
                        <span class="badge text-bg-primary me-2">${new Date(item.checkInTime).toTimeString().substring(0,5)}</span>
                        게스트 ${item.guestNickname} 님 ${item.homeTitle} 체크인
                      </span>
                      <button class="btn btn-sm btn-outline-secondary btn-memo-edit">메모</button>
                    </p>
                    ${memo ? `<small class="text-muted d-block ms-4">${memo}</small>` : `<small class="text-muted d-block ms-4">메모 없음</small>`}
                  </div>`;
              }
              // 체크아웃 카드
              if (item.checkOutTime) {
                const memo = (item.memoForCheckOut || '').replace(/"/g, '&quot;');
                html += `
                  <div class="schedule-item"
                       style="border-left-color:#dc3545;"
                       data-reservation-id="${item.reservationId}"
                       data-home-title="${item.homeTitle}"
                       data-guest="${item.guestNickname}"
                       data-memo-type="CHECKOUT"
                       data-memo="${memo}">
                    <p class="mb-1 d-flex align-items-center justify-content-between">
                      <span>
                        <span class="badge text-bg-secondary me-2">${new Date(item.checkOutTime).toTimeString().substring(0,5)}</span>
                        게스트 ${item.guestNickname} 님 ${item.homeTitle} 체크아웃
                      </span>
                      <button class="btn btn-sm btn-outline-secondary btn-memo-edit">메모</button>
                    </p>
                    ${memo ? `<small class="text-muted d-block ms-4">${memo}</small>` : `<small class="text-muted d-block ms-4">메모 없음</small>`}
                  </div>`;
              }
            });
          }
          box.innerHTML = html;
        })
        .catch(() => {
          box.innerHTML = `<h5><span class="text-primary">${day}</span>일 일정</h5><hr><p class="text-danger">일정 로딩에 실패했습니다.</p>`;
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
      // --------- 상태값 ----------
      let currentDateStr = null;
      let currentReservationId = null;
      let currentMemoType = null;

      // --------- 메모 모달 ----------
      function openMemoModal(el) {
        const item = el.closest('.schedule-item');
        currentReservationId = item.dataset.reservationId;
        currentMemoType = item.dataset.memoType;
        document.getElementById('memoTextarea').value = item.dataset.memo || '';
        document.getElementById('memoModalInfo').textContent =
          `${item.dataset.homeTitle} · ${item.dataset.guest}`;
        new bootstrap.Modal(document.getElementById('memoModal')).show();
      }

      async function saveMemo() {
        const memo = document.getElementById('memoTextarea').value;
        const res = await fetch(`/api/reservations/${currentReservationId}/memo?type=${currentMemoType}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ memo })
        });
        if (!res.ok) return alert('저장 실패');
        bootstrap.Modal.getInstance(document.getElementById('memoModal')).hide();
        if (currentDateStr) loadSchedules(currentDateStr);
      }

      async function deleteMemo() {
        if (!confirm('삭제할까요?')) return;
        const res = await fetch(`/api/reservations/${currentReservationId}/memo?type=${currentMemoType}`, { method: 'DELETE' });
        if (!res.ok) return alert('삭제 실패');
        bootstrap.Modal.getInstance(document.getElementById('memoModal')).hide();
        if (currentDateStr) loadSchedules(currentDateStr);
      }

      document.querySelector('.schedule-detail').addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-memo-edit')) openMemoModal(e.target);
      });
      document.getElementById('btnMemoSave').addEventListener('click', saveMemo);
      document.getElementById('btnMemoDelete').addEventListener('click', deleteMemo);

      // loadSchedules 호출 시 마지막 날짜 기억
      const originalLoadSchedules = window.loadSchedules;
      window.loadSchedules = function (dateStr) {
        currentDateStr = dateStr;
        return originalLoadSchedules(dateStr);
      };

      // ---------- 날짜 마커(점) ----------
      let dayMarks = {}; // {'YYYY-MM-DD': {in:true,out:false}}

      async function fetchDayMarks(startStr, endStr) {
        const s = startStr.slice(0, 10);
        const e = endStr.slice(0, 10);
        const res = await fetch(`/api/schedules/marks?start=${s}&end=${e}`);
        if (!res.ok) return;
        const arr = await res.json();
        dayMarks = {};
        arr.forEach(m => {
          dayMarks[m.date] = { in: !!m.checkIn, out: !!m.checkOut };
        });
      }

      function decorateCell(info) {
        const yyyy = info.date.getFullYear();
        const mm = String(info.date.getMonth() + 1).padStart(2, '0');
        const dd = String(info.date.getDate()).padStart(2, '0');
        const key = `${yyyy}-${mm}-${dd}`;
        const mark = dayMarks[key];
        const top = info.el.querySelector('.fc-daygrid-day-top');
        if (!top) return;

        const old = top.querySelector('.fc-dotwrap');
        if (old) old.remove();

        if (!mark) return;

        const wrap = document.createElement('div');
        wrap.className = 'fc-dotwrap';
        if (mark.in) {
          const dotIn = document.createElement('span');
          dotIn.className = 'fc-dot checkin';
          wrap.appendChild(dotIn);
        }
        if (mark.out) {
          const dotOut = document.createElement('span');
          dotOut.className = 'fc-dot checkout';
          wrap.appendChild(dotOut);
        }
        top.appendChild(wrap);
      }

      function decorateAllCells() {
        document.querySelectorAll('.fc-daygrid-day').forEach(cell => {
          const dateStr = cell.getAttribute('data-date'); // 'YYYY-MM-DD'
          const mark = dayMarks[dateStr];
          const top = cell.querySelector('.fc-daygrid-day-top');
          if (!top) return;

          const old = top.querySelector('.fc-dotwrap');
          if (old) old.remove();

          if (!mark) return;

          const wrap = document.createElement('div');
          wrap.className = 'fc-dotwrap';
          if (mark.in) {
            const dotIn = document.createElement('span');
            dotIn.className = 'fc-dot checkin';
            wrap.appendChild(dotIn);
          }
          if (mark.out) {
            const dotOut = document.createElement('span');
            dotOut.className = 'fc-dot checkout';
            wrap.appendChild(dotOut);
          }
          top.appendChild(wrap);
        });
      }

      // ---------- FullCalendar ----------
      const calendarEl = document.getElementById('calendar');
      const today = new Date();
      const tY = today.getFullYear();
      const tM = String(today.getMonth() + 1).padStart(2, '0');
      const tD = String(today.getDate()).padStart(2, '0');
      const todayStr = `${tY}-${tM}-${tD}`;

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: { left: 'prev', center: 'title', right: 'today,next' },
        events: '/api/schedules',
        dateClick: (info) => loadSchedules(info.dateStr),

        // 뷰 범위가 바뀔 때 마커 불러오고 모든 셀 다시 장식
        datesSet: async (info) => {
          await fetchDayMarks(info.startStr, info.endStr);
          decorateAllCells();
        },

        // 최초 셀 렌더 시 장식 (첫 화면 표시용)
        dayCellDidMount: decorateCell
      });

      calendar.render();
      loadSchedules(todayStr);
    });
  </script>
</body>
</html>
