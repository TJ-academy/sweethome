<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>회원가입</title>

<script>
function isValidEmail(email) {
    // 이메일 유효성 검사
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

//인증 코드 전송
function sendVerificationCode() {
    const email = document.getElementById("email").value;

 	// 이메일 형식이 올바른지 확인
    if (!isValidEmail(email)) {
        alert("올바른 이메일 주소를 입력해주세요.");
        return;
    }
 	
 	// 이메일 중복 확인
    fetch("/user/checkEmailDuplicate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "email=" + encodeURIComponent(email)
    })
    .then(res => res.text())
    .then(status => {
        if (status === "duplicate") {
            alert("이미 존재하는 이메일입니다.");
            return;
        }
        
        //중복이 아니면 이메일 인증 요청
        document.getElementById("verificationResult").innerText = "인증 코드 보내는 중..";
        
        return fetch("/user/mailConfirm", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "email=" + encodeURIComponent(email)
        });
    })
	.then(res => res.text())
	.then(msg => {
		document.getElementById("verificationResult").innerText = msg;
	})
	.catch(err => {
        document.getElementById("verificationResult").innerText = "오류가 발생했습니다. 다시 시도해주세요.";
        console.error(err);
    });
}

//인증 코드 확인 함수
function verifyCode() {
    const code = document.getElementById("emailCode").value;

    fetch("/user/verifyEmailCode?inputCode=" + code, {
        method: "POST"
    })
    .then(res => res.text())
    .then(msg => {
        document.getElementById("verificationResult").innerText = msg;
        if (msg === "인증이 완료되었습니다.") {
            document.getElementById("email").readonly = true;
            document.getElementById("emailBtn").disabled = true;
            document.getElementById("emailCode").disabled = true;
            document.getElementById("codeBtn").disabled = true;
            document.getElementById("joinBtn").disabled = false;
        }
    });
}

function autoHyphenPhone(target) {
    target.value = target.value
        .replace(/[^0-9]/g, '')  //숫자 외 문자 제거
        .replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);  //전화번호 형식
}

document.addEventListener('DOMContentLoaded', () => {
    const phoneInput = document.getElementById('phone');
    
    phoneInput.addEventListener('input', () => {
        autoHyphenPhone(phoneInput);
    });
});
</script>
</head>
<body>
<h1>회원가입</h1>
<form th:action="@{/user/join}" method="post">
    <label for="email">이메일:</label><br>
	<input type="email" id="email" name="email" 
		th:value="${kakaouser != null ? kakaouser.kakaoAccount.email : ''}" 
		th:readonly="${kakaouser != null or session.emailVerified == true}"
	required>
	<button type="button" id="emailBtn"
		th:disabled="${kakaouser != null}"
		onclick="sendVerificationCode()"
	>이메일 인증</button>
	
	<!-- 인증 코드 입력 -->
	<input type="text" id="emailCode" 
		placeholder="인증 코드 입력"
		th:value="${kakaouser != null} ? '인증완료' : ''" 
		th:disabled="${kakaouser != null}"
	>
	<button type="button" id="codeBtn"
		onclick="verifyCode()"
		th:disabled="${kakaouser != null}"
	>코드 확인</button>
	
	<!-- 인증 상태 표시 -->
	<p id="verificationResult" 
	th:value="${kakaouser != null} ? '인증이 완료되었습니다.' : ''"></p>

    <label for="password">비밀번호:</label><br>
    <input type="password" id="password" name="password" required><br><br>

    <label for="username">이름:</label><br>
    <input type="text" id="username" name="username" required><br><br>

    <label for="nickname">닉네임:</label><br>
    <input type="text" id="nickname" name="nickname" th:value="${kakaouser != null ? kakaouser.kakaoAccount.profile.nickname : ''}"><br><br>

    <label for="profileImg">프로필 이미지 URL:</label><br>
    <input type="text" id="profileImg" name="profileImg" th:value="${kakaouser != null ? kakaouser.kakaoAccount.profile.thumbnailImageUrl : ''}"><br><br>

    <label for="phone">전화번호:</label><br>
    <input type="text" id="phone" name="phone" required><br><br>

    <label for="birthday">생년월일:</label><br>
    <input type="date" id="birthday" name="birthday" required><br><br>

    <button type="submit" id="joinBtn" disabled>가입하기</button>
</form>
<a th:href="@{/user/cancelJoin}">Home</a>

</body>
</html>